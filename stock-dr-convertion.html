<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ DR (DR Price Calculator)</title>
    <meta name="description" content="‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ Depositary Receipts (DR) ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #ec4899;
            --success: #10b981;
            --success-bg: rgba(16, 185, 129, 0.1);
            --danger: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.1);
            --warning: #f59e0b;
            --warning-bg: rgba(245, 158, 11, 0.1);
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: rgba(30, 41, 59, 0.8);
            --bg-input: rgba(15, 23, 42, 0.6);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(148, 163, 184, 0.2);
            --border-focus: rgba(99, 102, 241, 0.5);
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --glass: rgba(255, 255, 255, 0.05);
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #e2e8f0;
            --bg-card: rgba(255, 255, 255, 0.9);
            --bg-input: rgba(241, 245, 249, 0.8);
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border: rgba(148, 163, 184, 0.3);
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
            --glass: rgba(255, 255, 255, 0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Kanit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 30% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 70% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.05) 0%, transparent 60%);
            z-index: -1;
            animation: gradientShift 20s ease infinite;
        }

        @keyframes gradientShift {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            25% {
                transform: translate(2%, 2%) rotate(5deg);
            }

            50% {
                transform: translate(-1%, 3%) rotate(-3deg);
            }

            75% {
                transform: translate(3%, -2%) rotate(2deg);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            animation: fadeInDown 0.6s ease;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-light), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .theme-toggle {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .theme-toggle:hover {
            transform: scale(1.05);
            border-color: var(--primary);
        }

        .theme-toggle svg {
            width: 20px;
            height: 20px;
            fill: var(--text-primary);
        }

        .container {
            width: 100%;
            max-width: 520px;
            animation: fadeInUp 0.6s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .card-header-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-header-icon svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .card-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .label-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .quick-picks {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .quick-picks-label {
            width: 100%;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .quick-picks-label svg {
            width: 12px;
            height: 12px;
            fill: var(--warning);
        }

        .quick-pick-btn {
            padding: 0.5rem 0.875rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 100px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .quick-pick-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px -4px rgba(99, 102, 241, 0.5);
        }

        .quick-pick-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        .quick-pick-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: transparent;
            color: white;
        }

        input,
        select {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input::placeholder {
            color: var(--text-muted);
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--border-focus);
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        .input-row {
            display: flex;
            gap: 0.5rem;
            align-items: stretch;
        }

        .input-row .input-with-icon {
            flex: 1;
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon input {
            padding-right: 3rem;
        }

        .input-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .fetch-btn {
            padding: 0 1rem;
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            white-space: nowrap;
        }

        .fetch-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px -5px rgba(16, 185, 129, 0.5);
        }

        .fetch-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .fetch-btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .fetch-btn.loading svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .rate-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .rate-info.success {
            color: var(--success);
        }

        .rate-info.loading {
            color: var(--warning);
        }

        .rate-info.error {
            color: var(--danger);
        }

        .rate-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 1.5s ease infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .stock-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-input);
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .stock-info.success {
            background: var(--success-bg);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .stock-info.warning {
            background: var(--warning-bg);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .stock-info.error {
            background: var(--danger-bg);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .stock-info-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stock-info-left svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        .stock-change {
            font-weight: 600;
        }

        .stock-change.positive {
            color: var(--success);
        }

        .stock-change.negative {
            color: var(--danger);
        }

        .btn {
            width: 100%;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px -10px rgba(99, 102, 241, 0.5);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .result-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: var(--shadow);
            display: none;
            animation: scaleIn 0.4s ease;
        }

        .result-card.visible {
            display: block;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .result-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .result-header h3 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .result-price {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: inline-flex;
            align-items: baseline;
            gap: 0.5rem;
        }

        .result-price .currency {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--text-muted);
            -webkit-text-fill-color: var(--text-muted);
        }

        .result-details {
            display: grid;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .detail-value {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .difference-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.375rem 0.75rem;
            border-radius: 100px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .difference-badge.premium {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .difference-badge.discount {
            background: var(--success-bg);
            color: var(--success);
        }

        .difference-badge svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        .copy-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.75rem;
            margin-top: 1.5rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        .copy-btn svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .history-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-top: 1.5rem;
        }

        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .history-header h3 {
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .history-header h3 svg {
            width: 16px;
            height: 16px;
            fill: var(--text-muted);
        }

        .clear-history {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .clear-history:hover {
            color: var(--danger);
        }

        .history-list {
            display: grid;
            gap: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border-radius: 12px;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .history-item:hover {
            background: var(--border);
        }

        .history-item-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .history-dr-symbol {
            font-weight: 600;
            color: var(--primary-light);
        }

        .history-time {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .history-price {
            font-weight: 600;
        }

        .empty-history {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .api-info {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border-radius: 12px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .api-info strong {
            color: var(--text-secondary);
        }

        .footer {
            margin-top: 2rem;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .footer a {
            color: var(--primary-light);
            text-decoration: none;
        }

        @media (max-width: 480px) {
            body {
                padding: 1rem;
            }

            .card,
            .result-card,
            .history-card {
                padding: 1.5rem;
                border-radius: 20px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .result-price {
                font-size: 2.5rem;
            }

            .input-row {
                flex-direction: column;
            }

            .fetch-btn {
                width: 100%;
                padding: 0.75rem 1rem;
                justify-content: center;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-input);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>

<body>
    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
        <svg id="themeIcon" viewBox="0 0 24 24">
            <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
        </svg>
    </button>

    <header class="header">
        <h1>ÔøΩ DR Price Calculator</h1>
        <p>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ Depositary Receipts ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏∏‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
    </header>

    <main class="container">
        <!-- Calculator Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-header-icon">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
                    </svg>
                </div>
                <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h2>
            </div>

            <form id="drCalculator" onsubmit="return false;">
                <div class="form-group">
                    <label for="drList">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å DR <span class="label-hint">(Select DR)</span></label>
                    <select id="drList" onchange="handleDrChange()">
                        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å DR --</option>
                    </select>

                    <!-- Quick Pick Favorites -->
                    <div class="quick-picks">
                        <span class="quick-picks-label">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
                            </svg>
                            Favorites
                        </span>
                        <button type="button" class="quick-pick-btn" onclick="quickPick('GOOG80')">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                                <path
                                    d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                                <path
                                    d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                                <path
                                    d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                            </svg>
                            GOOG80
                        </button>
                        <button type="button" class="quick-pick-btn" onclick="quickPick('QQQM19')">
                            <svg viewBox="0 0 24 24">
                                <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z" />
                            </svg>
                            QQQM19
                        </button>
                        <button type="button" class="quick-pick-btn" onclick="quickPick('TENCENT80')">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                            </svg>
                            TENCENT80
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="stockPrice">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏∏‡πâ‡∏ô‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á <span class="label-hint">(Underlying Price)</span></label>
                    <div class="input-row">
                        <div class="input-with-icon">
                            <input type="number" id="stockPrice" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å DR ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Fetch Price" step="0.01"
                                required>
                            <span class="input-icon">USD</span>
                        </div>
                        <button type="button" class="fetch-btn" id="fetchPriceBtn" onclick="fetchStockPrice()" disabled>
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                            </svg>
                            <span id="fetchBtnText">Fetch</span>
                        </button>
                    </div>
                    <div class="stock-info" id="stockInfo" style="display: none;">
                        <div class="stock-info-left">
                            <svg viewBox="0 0 24 24">
                                <path
                                    d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm6.93 6h-2.95c-.32-1.25-.78-2.45-1.38-3.56 1.84.63 3.37 1.91 4.33 3.56zM12 4.04c.83 1.2 1.48 2.53 1.91 3.96h-3.82c.43-1.43 1.08-2.76 1.91-3.96zM4.26 14C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2s.06 1.34.14 2H4.26zm.82 2h2.95c.32 1.25.78 2.45 1.38 3.56-1.84-.63-3.37-1.91-4.33-3.56zm2.95-8H5.08c.96-1.65 2.49-2.93 4.33-3.56C8.81 5.55 8.35 6.75 8.03 8zM12 19.96c-.83-1.2-1.48-2.53-1.91-3.96h3.82c-.43 1.43-1.08 2.76-1.91 3.96zM14.34 14H9.66c-.09-.66-.16-1.32-.16-2s.07-1.35.16-2h4.68c.09.65.16 1.32.16 2s-.07 1.34-.16 2zm.25 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95c-.96 1.65-2.49 2.93-4.33 3.56zM16.36 14c.08-.66.14-1.32.14-2s-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2h-3.38z" />
                            </svg>
                            <span id="stockInfoText">-</span>
                        </div>
                        <span class="stock-change" id="stockChange">-</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="exchangeRate">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô <span class="label-hint">(USD/THB)</span></label>
                    <div class="input-with-icon">
                        <input type="number" id="exchangeRate" placeholder="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î..." step="0.001" required>
                        <span class="input-icon">THB</span>
                    </div>
                    <div class="rate-info loading" id="rateInfo">
                        <span class="rate-dot"></span>
                        <span id="rateStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô...</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="drRatio">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô DR <span class="label-hint">(1 ‡∏´‡∏∏‡πâ‡∏ô : X DR)</span></label>
                    <div class="input-with-icon">
                        <input type="number" id="drRatio" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2000" required>
                        <span class="input-icon">DR</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="currentDrPrice">‡∏£‡∏≤‡∏Ñ‡∏≤ DR ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô <span class="label-hint">(‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö -
                            ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)</span></label>
                    <div class="input-with-icon">
                        <input type="number" id="currentDrPrice" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3.12" step="0.01">
                        <span class="input-icon">THB</span>
                    </div>
                </div>

                <button type="button" class="btn" onclick="calculateDRPrice()">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4 10h-2v2c0 .55-.45 1-1 1s-1-.45-1-1v-2H9c-.55 0-1-.45-1-1s.45-1 1-1h2V9c0-.55.45-1 1-1s1 .45 1 1v2h2c.55 0 1 .45 1 1s-.45 1-1 1z" />
                    </svg>
                    ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ DR
                </button>
            </form>

            <div class="api-info">
                <strong>üì° Data Sources:</strong> Stock prices from Yahoo Finance API, Exchange rates from
                ExchangeRate-API
            </div>
        </div>

        <!-- Result Card -->
        <div class="result-card" id="resultCard">
            <div class="result-header">
                <h3>‡∏£‡∏≤‡∏Ñ‡∏≤ DR ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô (Fair Value)</h3>
                <div class="result-price">
                    <span id="expectedDrPrice">0.000</span>
                    <span class="currency">THB</span>
                </div>
            </div>

            <div class="result-details">
                <div class="detail-row">
                    <span class="detail-label">DR Symbol</span>
                    <span class="detail-value" id="resultSymbol">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏∏‡πâ‡∏ô‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</span>
                    <span class="detail-value" id="resultStockPrice">$0.00</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</span>
                    <span class="detail-value" id="resultExchangeRate">0.000</span>
                </div>
                <div class="detail-row" id="differenceRow" style="display: none;">
                    <span class="detail-label">‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏•‡∏≤‡∏î</span>
                    <span class="difference-badge" id="differenceBadge">
                        <svg viewBox="0 0 24 24">
                            <path d="M7 14l5-5 5 5H7z" />
                        </svg>
                        <span id="differenceValue">0.00%</span>
                    </span>
                </div>
            </div>

            <button class="copy-btn" onclick="copyResult()">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" />
                </svg>
                ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            </button>
        </div>

        <!-- History Card -->
        <div class="history-card" id="historyCard">
            <div class="history-header">
                <h3>
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.25 2.52.77-1.28-3.52-2.09V8z" />
                    </svg>
                    ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                </h3>
                <button class="clear-history" onclick="clearHistory()">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            </div>
            <div class="history-list" id="historyList">
                <div class="empty-history">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>Made with ‚ù§Ô∏è | ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô</p>
    </footer>

    <script>
        // DR Data - Popular DRs traded on SET with ticker symbols
        const drData = {
            "AAPL80": { ratio: 2000, name: "Apple Inc.", ticker: "AAPL", category: "Tech" },
            "AMD80": { ratio: 5000, name: "AMD", ticker: "AMD", category: "Tech" },
            "AMZN80": { ratio: 1000, name: "Amazon", ticker: "AMZN", category: "Tech" },
            "GOOG80": { ratio: 2000, name: "Alphabet (Google)", ticker: "GOOG", category: "Tech" },
            "META80": { ratio: 2000, name: "Meta Platforms", ticker: "META", category: "Tech" },
            "MSFT80": { ratio: 2000, name: "Microsoft", ticker: "MSFT", category: "Tech" },
            "NVDA80": { ratio: 500, name: "NVIDIA", ticker: "NVDA", category: "Tech" },
            "TSLA80": { ratio: 1000, name: "Tesla", ticker: "TSLA", category: "Tech" },
            "QQQM19": { ratio: 500, name: "NASDAQ 100 ETF", ticker: "QQQ", category: "ETF" },
            "SPY19": { ratio: 200, name: "S&P 500 ETF", ticker: "SPY", category: "ETF" },
            "TENCENT80": { ratio: 100, name: "Tencent Holdings", ticker: "0700.HK", category: "China" },
            "BABA80": { ratio: 500, name: "Alibaba Group", ticker: "BABA", category: "China" },
            "JD80": { ratio: 1000, name: "JD.com", ticker: "JD", category: "China" },
            "NIO80": { ratio: 10000, name: "NIO Inc.", ticker: "NIO", category: "China" },
            "XPEV80": { ratio: 10000, name: "XPeng Inc.", ticker: "XPEV", category: "China" },
            "COIN80": { ratio: 2000, name: "Coinbase", ticker: "COIN", category: "Crypto" },
            "MSTR80": { ratio: 500, name: "MicroStrategy", ticker: "MSTR", category: "Crypto" },
        };

        // Stock price cache
        const priceCache = new Map();
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

        let calculationHistory = [];
        let currentTheme = 'dark';
        let isFetching = false;

        // Initialize on page load
        document.addEventListener("DOMContentLoaded", () => {
            initTheme();
            populateDrList();
            fetchExchangeRate();
            loadHistory();
        });

        // Theme functions
        function initTheme() {
            const savedTheme = localStorage.getItem('dr-theme') || 'dark';
            setTheme(savedTheme);
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(currentTheme);
        }

        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('dr-theme', theme);

            const icon = document.getElementById('themeIcon');
            if (theme === 'dark') {
                icon.innerHTML = '<path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"/>';
            } else {
                icon.innerHTML = '<path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>';
            }
        }

        // Populate DR dropdown with categories
        function populateDrList() {
            const drListSelect = document.getElementById("drList");
            const categories = {};

            // Group by category
            for (const symbol in drData) {
                const cat = drData[symbol].category;
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push({ symbol, ...drData[symbol] });
            }

            // Create optgroups
            for (const category in categories) {
                const optgroup = document.createElement("optgroup");
                optgroup.label = `üìÅ ${category}`;

                categories[category].forEach(dr => {
                    const option = document.createElement("option");
                    option.value = dr.symbol;
                    option.textContent = `${dr.symbol} - ${dr.name} (${dr.ticker})`;
                    optgroup.appendChild(option);
                });

                drListSelect.appendChild(optgroup);
            }
        }

        // Quick pick favorites
        function quickPick(symbol) {
            console.log('Quick pick clicked:', symbol);

            if (!drData[symbol]) {
                console.error('Symbol not found in drData:', symbol);
                return;
            }

            // Update dropdown selection
            const drList = document.getElementById("drList");
            drList.value = symbol;
            console.log('Dropdown value set to:', drList.value);

            // Update active state on buttons
            document.querySelectorAll('.quick-pick-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(symbol)) {
                    btn.classList.add('active');
                }
            });

            // Trigger the change handler (which will auto-fetch)
            handleDrChange();

            showToast(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${symbol} ‡πÅ‡∏•‡πâ‡∏ß`, "success");
        }

        function handleDrChange() {
            const selectedSymbol = document.getElementById("drList").value;
            const fetchBtn = document.getElementById("fetchPriceBtn");
            const stockInfo = document.getElementById("stockInfo");

            if (selectedSymbol && drData[selectedSymbol]) {
                document.getElementById("drRatio").value = drData[selectedSymbol].ratio;
                fetchBtn.disabled = false;

                // Check cache for existing price
                const cached = priceCache.get(selectedSymbol);
                if (cached && (Date.now() - cached.timestamp) < CACHE_DURATION) {
                    document.getElementById("stockPrice").value = cached.price.toFixed(2);
                    updateStockInfo(cached.price, cached.change, cached.changePercent);
                } else {
                    // Auto-fetch price when DR is selected
                    fetchStockPrice();
                }
            } else {
                document.getElementById("drRatio").value = "";
                document.getElementById("stockPrice").value = "";
                fetchBtn.disabled = true;
                stockInfo.style.display = "none";
            }
        }

        // Fetch stock price from Yahoo Finance via CORS proxy
        async function fetchStockPrice() {
            const selectedSymbol = document.getElementById("drList").value;
            if (!selectedSymbol || !drData[selectedSymbol]) {
                showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å DR ‡∏Å‡πà‡∏≠‡∏ô", "error");
                return;
            }

            if (isFetching) return;
            isFetching = true;

            const fetchBtn = document.getElementById("fetchPriceBtn");
            const fetchBtnText = document.getElementById("fetchBtnText");
            const stockInfo = document.getElementById("stockInfo");

            fetchBtn.classList.add("loading");
            fetchBtnText.textContent = "Loading...";
            fetchBtn.disabled = true;

            const ticker = drData[selectedSymbol].ticker;
            // For Google, also try GOOGL as alternate
            const altTickers = ticker === 'GOOG' ? ['GOOG', 'GOOGL'] : [ticker];

            try {
                let result = null;

                // Try multiple API sources with alternate tickers
                for (const t of altTickers) {
                    if (result) break;

                    // Try our own Vercel API first (no CORS issues!)
                    result = await tryFetchFromOwnAPI(t);

                    // Fallback: Try Yahoo Finance via CORS proxies
                    if (!result) result = await tryFetchFromYahoo(t);

                    // Fallback: Try Yahoo Quote API
                    if (!result) result = await tryFetchFromYahooQuote(t);

                    // Fallback: Try Finnhub
                    if (!result) result = await tryFetchFromFinnhub(t);

                    // Fallback: Try Alpha Vantage
                    if (!result) result = await tryFetchFromAlphaVantage(t);
                }

                if (result) {
                    document.getElementById("stockPrice").value = result.price.toFixed(2);

                    // Cache the result
                    priceCache.set(selectedSymbol, {
                        price: result.price,
                        change: result.change,
                        changePercent: result.changePercent,
                        timestamp: Date.now()
                    });

                    updateStockInfo(result.price, result.change, result.changePercent);
                    showToast(`‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤ ${ticker} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: $${result.price.toFixed(2)}`, "success");
                } else {
                    throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
                }
            } catch (error) {
                console.error("Failed to fetch stock price:", error);
                stockInfo.style.display = "flex";
                stockInfo.className = "stock-info error";
                document.getElementById("stockInfoText").textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á";
                document.getElementById("stockChange").textContent = "";
                showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏∏‡πâ‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á", "error");
            } finally {
                fetchBtn.classList.remove("loading");
                fetchBtnText.textContent = "Fetch";
                fetchBtn.disabled = false;
                isFetching = false;
            }
        }

        // Try fetching from our own Vercel API (deployed at /api/stock-price)
        async function tryFetchFromOwnAPI(ticker) {
            try {
                // Use relative URL when deployed on Vercel
                const isLocal = window.location.hostname === 'localhost' ||
                    window.location.hostname === '127.0.0.1' ||
                    window.location.protocol === 'file:';

                // Skip own API if running locally (won't work without Vercel)
                if (isLocal) {
                    console.log('Running locally, skipping own API');
                    return null;
                }

                const apiUrl = `/api/stock-price?symbol=${ticker}`;
                console.log(`Trying own API: ${apiUrl}`);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch(apiUrl, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    console.log(`Own API returned ${response.status}`);
                    return null;
                }

                const data = await response.json();

                if (data.price && data.price > 0) {
                    console.log(`‚úì Got price from own API: $${data.price}`);
                    return {
                        price: data.price,
                        change: data.change || 0,
                        changePercent: data.changePercent || 0
                    };
                }
                return null;
            } catch (error) {
                console.log('Own API fetch failed:', error.message);
                return null;
            }
        }

        // CORS Proxies to try (in order) - fallback when own API fails
        const corsProxies = [
            (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
            (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
            (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
        ];

        // Try fetching from Yahoo Finance via multiple CORS proxies
        async function tryFetchFromYahoo(ticker) {
            // Yahoo Finance API endpoints to try
            const yahooEndpoints = [
                `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`,
                `https://query2.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`,
            ];

            for (const endpoint of yahooEndpoints) {
                for (const proxyFn of corsProxies) {
                    try {
                        const proxyUrl = proxyFn(endpoint);
                        console.log(`Trying: ${proxyUrl}`);

                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 8000);

                        const response = await fetch(proxyUrl, {
                            signal: controller.signal,
                            headers: { 'Accept': 'application/json' }
                        });
                        clearTimeout(timeoutId);

                        if (!response.ok) continue;

                        const data = await response.json();

                        if (data.chart && data.chart.result && data.chart.result[0]) {
                            const result = data.chart.result[0];
                            const meta = result.meta;
                            const price = meta.regularMarketPrice;
                            const previousClose = meta.chartPreviousClose || meta.previousClose;

                            if (price && price > 0) {
                                const change = previousClose ? price - previousClose : 0;
                                const changePercent = previousClose ? (change / previousClose) * 100 : 0;
                                console.log(`‚úì Got price from Yahoo: $${price}`);
                                return { price, change, changePercent };
                            }
                        }
                    } catch (error) {
                        console.log(`Proxy attempt failed:`, error.message);
                        continue;
                    }
                }
            }
            return null;
        }

        // Try fetching from Yahoo v7 quote API (backup)
        async function tryFetchFromYahooQuote(ticker) {
            const quoteUrl = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${ticker}`;

            for (const proxyFn of corsProxies) {
                try {
                    const proxyUrl = proxyFn(quoteUrl);

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000);

                    const response = await fetch(proxyUrl, { signal: controller.signal });
                    clearTimeout(timeoutId);

                    if (!response.ok) continue;

                    const data = await response.json();

                    if (data.quoteResponse && data.quoteResponse.result && data.quoteResponse.result[0]) {
                        const quote = data.quoteResponse.result[0];
                        const price = quote.regularMarketPrice;

                        if (price && price > 0) {
                            console.log(`‚úì Got price from Yahoo Quote: $${price}`);
                            return {
                                price,
                                change: quote.regularMarketChange || 0,
                                changePercent: quote.regularMarketChangePercent || 0
                            };
                        }
                    }
                } catch (error) {
                    continue;
                }
            }
            return null;
        }

        // Try fetching from Finnhub (backup)
        async function tryFetchFromFinnhub(ticker) {
            // Skip non-US tickers for Finnhub
            if (ticker.includes('.')) return null;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${ticker}&token=demo`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) throw new Error('Finnhub fetch failed');

                const data = await response.json();

                if (data.c && data.c > 0) {
                    console.log(`‚úì Got price from Finnhub: $${data.c}`);
                    return {
                        price: data.c,
                        change: data.d || 0,
                        changePercent: data.dp || 0
                    };
                }
                return null;
            } catch (error) {
                console.log("Finnhub fetch failed:", error.message);
                return null;
            }
        }

        // Try fetching from Alpha Vantage (another backup)
        async function tryFetchFromAlphaVantage(ticker) {
            // Skip non-US tickers
            if (ticker.includes('.')) return null;

            try {
                // Using demo key (very limited)
                const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${ticker}&apikey=demo`;

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) return null;

                const data = await response.json();

                if (data['Global Quote'] && data['Global Quote']['05. price']) {
                    const price = parseFloat(data['Global Quote']['05. price']);
                    const change = parseFloat(data['Global Quote']['09. change']) || 0;
                    const changePercent = parseFloat(data['Global Quote']['10. change percent']?.replace('%', '')) || 0;

                    if (price > 0) {
                        console.log(`‚úì Got price from Alpha Vantage: $${price}`);
                        return { price, change, changePercent };
                    }
                }
                return null;
            } catch (error) {
                console.log("Alpha Vantage fetch failed:", error.message);
                return null;
            }
        }

        function updateStockInfo(price, change, changePercent) {
            const stockInfo = document.getElementById("stockInfo");
            const stockInfoText = document.getElementById("stockInfoText");
            const stockChange = document.getElementById("stockChange");

            stockInfo.style.display = "flex";
            stockInfo.className = "stock-info success";

            const time = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            stockInfoText.textContent = `Live price @ ${time}`;

            if (change !== undefined && changePercent !== undefined) {
                const sign = change >= 0 ? '+' : '';
                stockChange.textContent = `${sign}${change.toFixed(2)} (${sign}${changePercent.toFixed(2)}%)`;
                stockChange.className = `stock-change ${change >= 0 ? 'positive' : 'negative'}`;
            } else {
                stockChange.textContent = '';
            }
        }

        // Fetch exchange rate
        async function fetchExchangeRate() {
            const exchangeRateInput = document.getElementById("exchangeRate");
            const rateInfo = document.getElementById("rateInfo");
            const rateStatus = document.getElementById("rateStatus");

            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                const rate = data.rates.THB;

                if (rate) {
                    exchangeRateInput.value = rate.toFixed(3);
                    rateInfo.className = 'rate-info success';
                    rateStatus.textContent = `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date().toLocaleTimeString('th-TH')}`;
                } else {
                    throw new Error('Rate not found');
                }
            } catch (error) {
                console.error("Failed to fetch exchange rate:", error);
                rateInfo.className = 'rate-info error';
                rateStatus.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á";
                exchangeRateInput.placeholder = "‡πÄ‡∏ä‡πà‡∏ô 36.750";
            }
        }

        // Calculate DR Price
        function calculateDRPrice() {
            const stockPrice = parseFloat(document.getElementById("stockPrice").value);
            const exchangeRate = parseFloat(document.getElementById("exchangeRate").value);
            const drRatio = parseFloat(document.getElementById("drRatio").value);
            const currentDrPrice = parseFloat(document.getElementById("currentDrPrice").value);
            const selectedSymbol = document.getElementById("drList").value;

            if (isNaN(stockPrice) || isNaN(exchangeRate) || isNaN(drRatio) || drRatio <= 0) {
                showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", "error");
                return;
            }

            const expectedDrPrice = (stockPrice * exchangeRate) / drRatio;

            // Update result display
            document.getElementById("expectedDrPrice").textContent = expectedDrPrice.toFixed(3);
            document.getElementById("resultSymbol").textContent = selectedSymbol || "Custom";
            document.getElementById("resultStockPrice").textContent = `$${stockPrice.toFixed(2)}`;
            document.getElementById("resultExchangeRate").textContent = `${exchangeRate.toFixed(3)} THB`;

            const resultCard = document.getElementById("resultCard");
            resultCard.classList.add("visible");

            // Handle difference calculation
            const differenceRow = document.getElementById("differenceRow");
            const differenceBadge = document.getElementById("differenceBadge");
            const differenceValue = document.getElementById("differenceValue");

            if (!isNaN(currentDrPrice) && currentDrPrice > 0) {
                const difference = ((currentDrPrice - expectedDrPrice) / expectedDrPrice) * 100;
                differenceValue.textContent = `${difference > 0 ? '+' : ''}${difference.toFixed(2)}%`;

                if (difference > 0) {
                    differenceBadge.className = 'difference-badge premium';
                    differenceBadge.querySelector('svg').innerHTML = '<path d="M7 14l5-5 5 5H7z"/>';
                } else {
                    differenceBadge.className = 'difference-badge discount';
                    differenceBadge.querySelector('svg').innerHTML = '<path d="M7 10l5 5 5-5H7z"/>';
                }
                differenceRow.style.display = 'flex';
            } else {
                differenceRow.style.display = 'none';
            }

            // Add to history
            addToHistory({
                symbol: selectedSymbol || "Custom",
                stockPrice,
                exchangeRate,
                drRatio,
                expectedPrice: expectedDrPrice,
                currentPrice: currentDrPrice || null,
                timestamp: new Date().toISOString()
            });

            // Scroll to result
            resultCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // History functions
        function loadHistory() {
            const saved = localStorage.getItem('dr-calc-history');
            if (saved) {
                calculationHistory = JSON.parse(saved);
                renderHistory();
            }
        }

        function addToHistory(entry) {
            calculationHistory.unshift(entry);
            if (calculationHistory.length > 10) {
                calculationHistory = calculationHistory.slice(0, 10);
            }
            localStorage.setItem('dr-calc-history', JSON.stringify(calculationHistory));
            renderHistory();
        }

        function renderHistory() {
            const historyList = document.getElementById("historyList");

            if (calculationHistory.length === 0) {
                historyList.innerHTML = '<div class="empty-history">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</div>';
                return;
            }

            historyList.innerHTML = calculationHistory.map((entry, index) => {
                const time = new Date(entry.timestamp).toLocaleTimeString('th-TH', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const date = new Date(entry.timestamp).toLocaleDateString('th-TH', {
                    day: 'numeric',
                    month: 'short'
                });

                return `
                    <div class="history-item" onclick="loadFromHistory(${index})">
                        <div class="history-item-info">
                            <span class="history-dr-symbol">${entry.symbol}</span>
                            <span class="history-time">${date} ${time}</span>
                        </div>
                        <span class="history-price">${entry.expectedPrice.toFixed(3)} THB</span>
                    </div>
                `;
            }).join('');
        }

        function loadFromHistory(index) {
            const entry = calculationHistory[index];
            document.getElementById("drList").value = entry.symbol;
            document.getElementById("stockPrice").value = entry.stockPrice;
            document.getElementById("exchangeRate").value = entry.exchangeRate;
            document.getElementById("drRatio").value = entry.drRatio;
            if (entry.currentPrice) {
                document.getElementById("currentDrPrice").value = entry.currentPrice;
            }

            // Enable fetch button
            document.getElementById("fetchPriceBtn").disabled = !drData[entry.symbol];

            calculateDRPrice();
        }

        function clearHistory() {
            calculationHistory = [];
            localStorage.removeItem('dr-calc-history');
            renderHistory();
            showToast("‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", "success");
        }

        // Copy result
        function copyResult() {
            const symbol = document.getElementById("resultSymbol").textContent;
            const price = document.getElementById("expectedDrPrice").textContent;
            const stockPrice = document.getElementById("resultStockPrice").textContent;
            const rate = document.getElementById("resultExchangeRate").textContent;

            const text = `DR Calculator Result\n` +
                `Symbol: ${symbol}\n` +
                `Fair Value: ${price} THB\n` +
                `Stock Price: ${stockPrice}\n` +
                `Exchange Rate: ${rate}`;

            navigator.clipboard.writeText(text).then(() => {
                showToast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏•‡πâ‡∏ß!", "success");
            }).catch(err => {
                showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ", "error");
            });
        }

        // Toast notification
        function showToast(message, type = 'info') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.cssText = `
                position: fixed;
                bottom: 2rem;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'error' ? 'var(--danger)' : 'var(--success)'};
                color: white;
                padding: 0.75rem 1.5rem;
                border-radius: 100px;
                font-size: 0.875rem;
                font-weight: 500;
                z-index: 1000;
                animation: toastIn 0.3s ease;
                max-width: 90%;
                text-align: center;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'toastOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Add toast animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes toastIn {
                from { opacity: 0; transform: translateX(-50%) translateY(20px); }
                to { opacity: 1; transform: translateX(-50%) translateY(0); }
            }
            @keyframes toastOut {
                from { opacity: 1; transform: translateX(-50%) translateY(0); }
                to { opacity: 0; transform: translateX(-50%) translateY(20px); }
            }
        `;
        document.head.appendChild(style);

        // Keyboard shortcut
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.target.tagName !== 'BUTTON') {
                calculateDRPrice();
            }
        });
    </script>
</body>

</html>