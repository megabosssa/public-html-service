<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DQL Query Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for the textarea */
        textarea::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        textarea::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }
        
        .transition-transform {
            transition-property: transform;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen p-4">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="flex items-center space-x-3 pb-4 border-b border-slate-200">
            <div class="bg-blue-600 p-2 rounded-lg text-white">
                <i data-lucide="terminal" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-slate-900">DQL Query Builder</h1>
                <p class="text-slate-500 text-sm">Generate standardized Dynatrace log queries for API Factory</p>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- LEFT COLUMN: Builder Controls -->
            <div class="space-y-6">
                
                <!-- Block 1: Source & Time -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex items-center space-x-2">
                        <i data-lucide="filter" class="w-4 h-4 text-blue-500"></i>
                        <h2 class="font-semibold text-slate-700">1. Log Source & Time</h2>
                    </div>
                    <div class="p-4 space-y-4">
                        
                        <!-- Time Selection -->
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 space-y-3">
                            <div class="flex items-center space-x-2 mb-2">
                                <i data-lucide="clock" class="w-4 h-4 text-slate-500"></i>
                                <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Time Range</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2" id="timeModeButtons">
                                <button data-mode="none" class="text-xs py-1.5 px-2 rounded border transition-colors bg-blue-50 border-blue-200 text-blue-700 font-medium">Default</button>
                                <button data-mode="relative" class="text-xs py-1.5 px-2 rounded border transition-colors bg-white border-slate-200 text-slate-600 hover:bg-slate-50">Last X Hours</button>
                                <button data-mode="range" class="text-xs py-1.5 px-2 rounded border transition-colors bg-white border-slate-200 text-slate-600 hover:bg-slate-50">Date Range</button>
                            </div>

                            <!-- Relative Time Input -->
                            <div id="relativeTimeContainer" class="hidden flex items-center space-x-2 mt-2">
                                <span class="text-sm text-slate-600">Last</span>
                                <input type="number" id="relativeTimeInput" min="1" value="2" class="w-16 bg-white border border-slate-300 text-slate-900 text-sm rounded p-1 text-center">
                                <span class="text-sm text-slate-600">hours</span>
                            </div>

                            <!-- Date Range Inputs -->
                            <div id="rangeTimeContainer" class="hidden grid grid-cols-1 gap-2 mt-2">
                                <div>
                                    <label class="text-xs text-slate-500 block mb-1">From (ISO Timestamp)</label>
                                    <input type="text" id="startTimeInput" placeholder="2023-10-27T08:00:00" class="w-full bg-white border border-slate-300 text-slate-900 text-xs rounded p-1.5 font-mono">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500 block mb-1">To (ISO Timestamp)</label>
                                    <input type="text" id="endTimeInput" placeholder="2023-10-27T10:00:00" class="w-full bg-white border border-slate-300 text-slate-900 text-xs rounded p-1.5 font-mono">
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-slate-100 pt-3">
                            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">K8s Namespace</label>
                            <select id="namespaceSelect" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 font-mono">
                                <option value="api-factory-dev">api-factory-dev</option>
                                <option value="api-factory-sit">api-factory-sit</option>
                                <option value="api-factory-uat" selected>api-factory-uat</option>
                                <option value="Custom">Custom</option>
                            </select>
                            <input type="text" id="customNamespaceInput" class="hidden mt-2 w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 font-mono" placeholder="Enter Custom Namespace">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Content Path / API Pattern</label>
                            <input type="text" id="contentPathInput" value="*/rest/api/v1/corporateServices/directDebit/refund/confirmation*" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 font-mono" placeholder="e.g. */rest/api/v1/...">
                        </div>
                    </div>
                </div>

                <!-- Block 2: Additional Filters -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex justify-between items-center">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="settings" class="w-4 h-4 text-purple-500"></i>
                            <h2 class="font-semibold text-slate-700">2. Extra Filters</h2>
                        </div>
                        <button id="addPhraseBtn" class="text-xs bg-white hover:bg-slate-100 border border-slate-300 px-2 py-1 rounded flex items-center transition-colors">
                            <i data-lucide="plus" class="w-3 h-3 mr-1"></i> Add Filter
                        </button>
                    </div>
                    <div id="phrasesContainer" class="p-4 space-y-3">
                        <!-- Phrases will be injected here via JS -->
                    </div>
                </div>

                <!-- Block 3: Logic & Fields -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="code" class="w-4 h-4 text-green-600"></i>
                            <h2 class="font-semibold text-slate-700">3. App Logic & Output</h2>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-xs text-slate-600 font-medium cursor-pointer" for="parsingToggle">Standard Parsing</label>
                            <div id="parsingToggle" class="w-8 h-4 rounded-full p-0.5 cursor-pointer transition-colors bg-green-500">
                                <div class="w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform translate-x-4"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="logicContainer" class="divide-y divide-slate-100">
                        <!-- Logic Section -->
                        <div class="p-4 space-y-4">
                            <!-- Performance Toggle -->
                            <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 flex items-start space-x-3">
                                <i data-lucide="zap" class="w-5 h-5 text-amber-500 mt-0.5 flex-shrink-0"></i>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm font-semibold text-amber-900">Smart Optimization</span>
                                        <div id="optToggle" class="w-8 h-4 rounded-full p-0.5 cursor-pointer transition-colors bg-amber-500">
                                            <div class="w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform translate-x-4"></div>
                                        </div>
                                    </div>
                                    <p class="text-xs text-amber-800 mt-1 leading-relaxed">
                                        Adds coarse text filters <em>before</em> parsing.
                                    </p>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="col-span-1 md:col-span-2">
                                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Service Type</label>
                                    <select id="serviceTypeSelect" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                        <option value="SELF" selected>SELF</option>
                                        <option value="DB">DB</option>
                                        <option value="DataSource">DataSource</option>
                                        <option value="KAFKA-TOPIC-LISTENER">KAFKA-TOPIC-LISTENER</option>
                                        <option value="PUBSUB-QUEUE-LISTENER">PUBSUB-QUEUE-LISTENER</option>
                                        <option value="RestTemplate">RestTemplate</option>
                                        <option value="RestTemplate-Annotation">RestTemplate-Annotation</option>
                                        <option value="RestTemplate-Annotation-Proxy">RestTemplate-Annotation-Proxy</option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                    <input type="text" id="customServiceTypeInput" class="hidden mt-2 w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" placeholder="Enter Custom Service Type">
                                </div>

                                <div>
                                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Service Name</label>
                                    <input type="text" id="serviceNameInput" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" placeholder="Optional">
                                </div>

                                <div>
                                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Status Code</label>
                                    <input type="text" id="statusCodeInput" class="w-full bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5" placeholder="Optional">
                                </div>
                            </div>
                        </div>

                        <!-- Fields Section -->
                        <div class="p-4 bg-slate-50">
                            <div class="flex items-center space-x-2 mb-3">
                                <i data-lucide="columns" class="w-4 h-4 text-blue-500"></i>
                                <h3 class="text-sm font-semibold text-slate-700">Output Fields</h3>
                            </div>
                            <div id="fieldsContainer" class="grid grid-cols-2 gap-2">
                                <!-- Fields injected via JS -->
                            </div>
                        </div>
                    </div>
                    <!-- Disabled State -->
                    <div id="parsingDisabledMsg" class="hidden p-8 text-center text-slate-400 text-sm">
                        Standard JSON parsing disabled. Query will return raw logs.
                    </div>
                </div>

                <!-- Block 4: Output Options -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                   <div class="flex items-center space-x-3">
                     <span class="text-sm font-semibold text-slate-700">Sort Order</span>
                     <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button id="sortDescBtn" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all bg-white shadow text-blue-600">Newest First</button>
                        <button id="sortAscBtn" class="px-3 py-1.5 text-xs font-medium rounded-md transition-all text-slate-500 hover:text-slate-700">Oldest First</button>
                     </div>
                   </div>

                   <div class="flex items-center space-x-3">
                     <span class="text-sm font-semibold text-slate-700">Record Limit</span>
                     <input type="number" id="limitInput" value="40" class="w-24 bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 text-center">
                   </div>
                </div>

            </div>

            <!-- RIGHT COLUMN: Output -->
            <div class="flex flex-col h-full">
                <div class="bg-slate-900 rounded-xl shadow-lg overflow-hidden flex flex-col min-h-[600px] h-[85vh] lg:sticky lg:top-6">
                    <div class="bg-slate-800 px-4 py-3 flex justify-between items-center border-b border-slate-700">
                        <span class="text-slate-300 font-mono text-sm flex items-center">
                            <i data-lucide="terminal" class="w-4 h-4 mr-2"></i>
                            DQL Output
                        </span>
                        <button id="copyBtn" class="flex items-center space-x-1 text-xs px-3 py-1.5 rounded-md transition-all bg-slate-700 text-slate-300 hover:bg-slate-600">
                            <i data-lucide="copy" class="w-3 h-3"></i>
                            <span id="copyBtnText">Copy Query</span>
                        </button>
                    </div>
                    <div class="flex-1 p-0 overflow-hidden relative group">
                        <textarea id="outputArea" readonly class="w-full h-full bg-slate-900 text-blue-200 font-mono text-sm p-4 outline-none resize-none leading-relaxed" spellcheck="false"></textarea>
                    </div>
                    <div class="bg-slate-800 px-4 py-2 text-xs text-slate-500 border-t border-slate-700 flex justify-between">
                        <span>Auto-generated based on inputs</span>
                        <span id="lineCount">0 lines</span>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Application Logic -->
    <script>
        // --- State ---
        const state = {
            namespace: "api-factory-uat",
            customNamespace: "",
            contentPath: "*/rest/api/v1/corporateServices/directDebit/refund/confirmation*",
            timeMode: "none", // none, relative, range
            relativeTime: 2,
            startTime: "",
            endTime: "",
            phrases: [
                { id: 1, value: "middleName", enabled: false, isWildcard: false },
                { id: 2, value: "4410002", enabled: false, isWildcard: false }
            ],
            parsingEnabled: true,
            optimizationEnabled: true,
            serviceType: "SELF",
            customServiceType: "",
            serviceName: "",
            statusCode: "",
            sortOrder: "desc",
            limit: 40,
            outputFields: [
                { id: 'timestamp', label: 'timestamp', expression: '', enabled: true },
                { id: 'content', label: 'content (Raw Log)', expression: '', enabled: true },
                { id: 'trace_id', label: 'trace_id', expression: 'jcontent[traceId]', enabled: true },
                { id: 'serviceType', label: 'serviceType', expression: 'jmessage[serviceType]', enabled: true },
                { id: 'serviceName', label: 'serviceName', expression: 'jmessage[serviceName]', enabled: true },
                { id: 'statusCode', label: 'statusCode', expression: 'jmessage[statusCode]', enabled: true },
                { id: 'message', label: 'message', expression: 'jcontent[message]', enabled: true },
                { id: 'springAppName', label: 'springAppName', expression: 'jcontent[springAppName]', enabled: true },
                { id: 'requestData', label: 'requestData', expression: 'jmessage[requestData]', enabled: true },
                { id: 'responseData', label: 'responseData', expression: 'jmessage[responseData]', enabled: true },
            ]
        };

        // --- DOM Elements ---
        const els = {
            timeBtns: document.querySelectorAll('#timeModeButtons button'),
            relativeTimeContainer: document.getElementById('relativeTimeContainer'),
            relativeTimeInput: document.getElementById('relativeTimeInput'),
            rangeTimeContainer: document.getElementById('rangeTimeContainer'),
            startTimeInput: document.getElementById('startTimeInput'),
            endTimeInput: document.getElementById('endTimeInput'),
            namespaceSelect: document.getElementById('namespaceSelect'),
            customNamespaceInput: document.getElementById('customNamespaceInput'),
            contentPathInput: document.getElementById('contentPathInput'),
            phrasesContainer: document.getElementById('phrasesContainer'),
            addPhraseBtn: document.getElementById('addPhraseBtn'),
            parsingToggle: document.getElementById('parsingToggle'),
            optToggle: document.getElementById('optToggle'),
            logicContainer: document.getElementById('logicContainer'),
            parsingDisabledMsg: document.getElementById('parsingDisabledMsg'),
            serviceTypeSelect: document.getElementById('serviceTypeSelect'),
            customServiceTypeInput: document.getElementById('customServiceTypeInput'),
            serviceNameInput: document.getElementById('serviceNameInput'),
            statusCodeInput: document.getElementById('statusCodeInput'),
            fieldsContainer: document.getElementById('fieldsContainer'),
            sortDescBtn: document.getElementById('sortDescBtn'),
            sortAscBtn: document.getElementById('sortAscBtn'),
            limitInput: document.getElementById('limitInput'),
            outputArea: document.getElementById('outputArea'),
            copyBtn: document.getElementById('copyBtn'),
            copyBtnText: document.getElementById('copyBtnText'),
            lineCount: document.getElementById('lineCount')
        };

        // --- Render Functions ---

        function renderTimeUI() {
            // Update buttons style
            els.timeBtns.forEach(btn => {
                const mode = btn.dataset.mode;
                if (mode === state.timeMode) {
                    btn.className = "text-xs py-1.5 px-2 rounded border transition-colors bg-blue-50 border-blue-200 text-blue-700 font-medium";
                } else {
                    btn.className = "text-xs py-1.5 px-2 rounded border transition-colors bg-white border-slate-200 text-slate-600 hover:bg-slate-50";
                }
            });

            // Show/Hide Inputs
            els.relativeTimeContainer.classList.add('hidden');
            els.rangeTimeContainer.classList.add('hidden');

            if (state.timeMode === 'relative') {
                els.relativeTimeContainer.classList.remove('hidden');
            } else if (state.timeMode === 'range') {
                els.rangeTimeContainer.classList.remove('hidden');
            }
        }

        function renderNamespaceUI() {
            if (state.namespace === "Custom") {
                els.customNamespaceInput.classList.remove('hidden');
            } else {
                els.customNamespaceInput.classList.add('hidden');
            }
        }

        function renderServiceUI() {
            if (state.serviceType === "Custom") {
                els.customServiceTypeInput.classList.remove('hidden');
            } else {
                els.customServiceTypeInput.classList.add('hidden');
            }
        }

        function renderToggle(element, enabled, activeClass = "bg-green-500", inactiveClass = "bg-slate-300") {
            const circle = element.querySelector('div');
            if (enabled) {
                element.className = `w-8 h-4 rounded-full p-0.5 cursor-pointer transition-colors ${activeClass}`;
                circle.className = `w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform translate-x-4`;
            } else {
                element.className = `w-8 h-4 rounded-full p-0.5 cursor-pointer transition-colors ${inactiveClass}`;
                circle.className = `w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform translate-x-0`;
            }
        }

        function renderParsingUI() {
            renderToggle(els.parsingToggle, state.parsingEnabled, "bg-green-500");
            renderToggle(els.optToggle, state.optimizationEnabled, "bg-amber-500");
            
            if (state.parsingEnabled) {
                els.logicContainer.classList.remove('hidden');
                els.parsingDisabledMsg.classList.add('hidden');
            } else {
                els.logicContainer.classList.add('hidden');
                els.parsingDisabledMsg.classList.remove('hidden');
            }
        }

        function renderPhrases() {
            els.phrasesContainer.innerHTML = '';
            
            if (state.phrases.length === 0) {
                els.phrasesContainer.innerHTML = `<p class="text-sm text-slate-400 italic">No extra phrase filters added.</p>`;
                return;
            }

            state.phrases.forEach(p => {
                const row = document.createElement('div');
                row.className = "flex flex-col sm:flex-row sm:items-center gap-2 p-2 bg-slate-50 rounded-lg border border-slate-100";
                
                row.innerHTML = `
                    <div class="flex items-center space-x-2 flex-1">
                      <input type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500" ${p.enabled ? 'checked' : ''} onchange="updatePhrase(${p.id}, 'enabled', this.checked)">
                      <input type="text" value="${p.value}" class="w-full border text-sm rounded-lg p-2 font-mono ${p.enabled ? 'bg-white border-slate-300' : 'bg-slate-100 border-slate-200 text-slate-400'}" placeholder="Search phrase" oninput="updatePhrase(${p.id}, 'value', this.value)">
                    </div>
                    <div class="flex items-center justify-between sm:justify-end space-x-2 pl-6 sm:pl-0">
                      <label class="flex items-center space-x-1 cursor-pointer select-none">
                        <input type="checkbox" class="w-3 h-3 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500" ${p.isWildcard ? 'checked' : ''} onchange="updatePhrase(${p.id}, 'isWildcard', this.checked)">
                        <span class="text-xs text-slate-500 font-medium whitespace-nowrap">Wildcard (*)</span>
                      </label>
                      <button onclick="removePhrase(${p.id})" class="text-slate-400 hover:text-red-500 p-1">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                      </button>
                    </div>
                `;
                els.phrasesContainer.appendChild(row);
            });
            lucide.createIcons();
        }

        function renderFields() {
            els.fieldsContainer.innerHTML = '';
            state.outputFields.forEach(f => {
                const label = document.createElement('label');
                label.className = "flex items-center space-x-2 cursor-pointer p-2 rounded hover:bg-slate-100 transition-colors";
                label.innerHTML = `
                    <input type="checkbox" class="w-4 h-4 text-blue-600 bg-white border-gray-300 rounded focus:ring-blue-500" ${f.enabled ? 'checked' : ''} onchange="toggleField('${f.id}')">
                    <span class="text-xs font-mono ${f.enabled ? 'text-slate-800' : 'text-slate-400'}">${f.label}</span>
                `;
                els.fieldsContainer.appendChild(label);
            });
        }

        function renderSortUI() {
            const activeClass = "bg-white shadow text-blue-600";
            const inactiveClass = "text-slate-500 hover:text-slate-700";
            
            if (state.sortOrder === 'desc') {
                els.sortDescBtn.className = `px-3 py-1.5 text-xs font-medium rounded-md transition-all ${activeClass}`;
                els.sortAscBtn.className = `px-3 py-1.5 text-xs font-medium rounded-md transition-all ${inactiveClass}`;
            } else {
                els.sortDescBtn.className = `px-3 py-1.5 text-xs font-medium rounded-md transition-all ${inactiveClass}`;
                els.sortAscBtn.className = `px-3 py-1.5 text-xs font-medium rounded-md transition-all ${activeClass}`;
            }
        }

        // --- Logic & Generation ---

        function generateDQL() {
            let dql = `fetch logs`;
            
            // Time Logic
            if (state.timeMode === "relative") {
                dql += `, from: -${state.relativeTime}h`;
            } else if (state.timeMode === "range") {
                if (state.startTime) dql += `, from: "${state.startTime}"`;
                if (state.endTime) dql += `, to: "${state.endTime}"`;
            }
            dql += `\n`;

            // Namespace
            const activeNamespace = state.namespace === "Custom" ? state.customNamespace : state.namespace;
            if (activeNamespace) {
                dql += `| filter matchesValue(k8s.namespace.name, "${activeNamespace}")\n`;
            }

            // Content Path
            if (state.contentPath) {
                dql += `| filter matchesValue(content, "${state.contentPath}")\n`;
            }

            // Optimization
            if (state.optimizationEnabled && state.parsingEnabled) {
                const activeServiceType = state.serviceType === "Custom" ? state.customServiceType : state.serviceType;
                
                if (activeServiceType) {
                    dql += `| filter matchesPhrase(content, "${activeServiceType}") // Optimization: Pre-filter\n`;
                }
                if (state.serviceName) {
                    dql += `| filter matchesPhrase(content, "${state.serviceName}") // Optimization: Pre-filter\n`;
                }
            }

            // Phrases
            state.phrases.forEach(p => {
                if (!p.enabled) return;
                let value = p.value;
                let func = "matchesPhrase";
                if (p.isWildcard) {
                    value = `*${value}*`;
                    func = "matchesValue";
                }
                dql += `| filter ${func}(content, "${value}")\n`;
            });

            dql += `| sort timestamp ${state.sortOrder}\n`;

            // Parsing & Logic
            if (state.parsingEnabled) {
                dql += `| parse content, "json:jcontent"\n`;
                dql += `| parse jcontent[message], "json:jmessage"\n`;
                
                const enabledFields = state.outputFields.filter(f => f.enabled);
                if (enabledFields.length > 0) {
                    dql += `| fields `;
                    const fieldStrings = enabledFields.map(f => {
                        return f.expression ? `${f.id} = ${f.expression}` : f.id;
                    });
                    dql += fieldStrings.join(',\n         ');
                    dql += '\n';
                }

                const activeServiceType = state.serviceType === "Custom" ? state.customServiceType : state.serviceType;
                if (activeServiceType) {
                    dql += `| filter serviceType == "${activeServiceType}"\n`;
                }
                if (state.serviceName) {
                    dql += `| filter serviceName == "${state.serviceName}"\n`;
                }
                if (state.statusCode) {
                    dql += `| filter statusCode == "${state.statusCode}"\n`;
                }
            }

            dql += `| limit ${state.limit}`;

            // Update Output
            els.outputArea.value = dql;
            els.lineCount.textContent = `${dql.split('\n').length} lines`;
        }

        // --- Event Handlers & Helpers ---

        // Global functions for inline HTML events
        window.updatePhrase = (id, field, value) => {
            const idx = state.phrases.findIndex(p => p.id === id);
            if (idx > -1) {
                state.phrases[idx][field] = value;
                // Re-render only if we need to update styling, otherwise just regen DQL
                if (field === 'enabled') {
                    renderPhrases(); 
                }
                generateDQL();
            }
        };

        window.removePhrase = (id) => {
            state.phrases = state.phrases.filter(p => p.id !== id);
            renderPhrases();
            generateDQL();
        };

        window.toggleField = (id) => {
            const idx = state.outputFields.findIndex(f => f.id === id);
            if (idx > -1) {
                state.outputFields[idx].enabled = !state.outputFields[idx].enabled;
                renderFields();
                generateDQL();
            }
        };

        // DOM Event Listeners
        els.timeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                state.timeMode = btn.dataset.mode;
                renderTimeUI();
                generateDQL();
            });
        });

        els.relativeTimeInput.addEventListener('input', (e) => {
            state.relativeTime = e.target.value;
            generateDQL();
        });

        els.startTimeInput.addEventListener('input', (e) => {
            state.startTime = e.target.value;
            generateDQL();
        });
        
        els.endTimeInput.addEventListener('input', (e) => {
            state.endTime = e.target.value;
            generateDQL();
        });

        els.namespaceSelect.addEventListener('change', (e) => {
            state.namespace = e.target.value;
            renderNamespaceUI();
            generateDQL();
        });

        els.customNamespaceInput.addEventListener('input', (e) => {
            state.customNamespace = e.target.value;
            generateDQL();
        });

        els.contentPathInput.addEventListener('input', (e) => {
            state.contentPath = e.target.value;
            generateDQL();
        });

        els.addPhraseBtn.addEventListener('click', () => {
            state.phrases.push({ id: Date.now(), value: "", enabled: true, isWildcard: true });
            renderPhrases();
            generateDQL();
        });

        els.parsingToggle.addEventListener('click', () => {
            state.parsingEnabled = !state.parsingEnabled;
            renderParsingUI();
            generateDQL();
        });

        els.optToggle.addEventListener('click', () => {
            state.optimizationEnabled = !state.optimizationEnabled;
            renderParsingUI(); // Updates UI
            generateDQL();
        });

        els.serviceTypeSelect.addEventListener('change', (e) => {
            state.serviceType = e.target.value;
            renderServiceUI();
            generateDQL();
        });

        els.customServiceTypeInput.addEventListener('input', (e) => {
            state.customServiceType = e.target.value;
            generateDQL();
        });

        els.serviceNameInput.addEventListener('input', (e) => {
            state.serviceName = e.target.value;
            generateDQL();
        });

        els.statusCodeInput.addEventListener('input', (e) => {
            state.statusCode = e.target.value;
            generateDQL();
        });

        els.sortDescBtn.addEventListener('click', () => {
            state.sortOrder = 'desc';
            renderSortUI();
            generateDQL();
        });

        els.sortAscBtn.addEventListener('click', () => {
            state.sortOrder = 'asc';
            renderSortUI();
            generateDQL();
        });

        els.limitInput.addEventListener('input', (e) => {
            state.limit = e.target.value;
            generateDQL();
        });

        els.copyBtn.addEventListener('click', () => {
            els.outputArea.select();
            document.execCommand('copy');
            
            // Visual feedback
            const originalText = els.copyBtnText.textContent;
            const icon = els.copyBtn.querySelector('i');
            els.copyBtnText.textContent = "Copied!";
            els.copyBtn.classList.replace('bg-slate-700', 'bg-green-600');
            
            setTimeout(() => {
                els.copyBtnText.textContent = originalText;
                els.copyBtn.classList.replace('bg-green-600', 'bg-slate-700');
            }, 2000);
        });

        // Initialize
        renderTimeUI();
        renderNamespaceUI();
        renderServiceUI();
        renderParsingUI();
        renderPhrases();
        renderFields();
        renderSortUI();
        generateDQL();
        lucide.createIcons();

    </script>
</body>
</html>