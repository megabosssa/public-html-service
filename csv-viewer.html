<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="View, edit, and export CSV files with an interactive table interface">
    <title>CSV Viewer/Editor | Dev Tools</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="shared-styles.css">
    <style>
        .csv-input-section {
            margin-bottom: 1.5rem;
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            background: var(--color-bg-secondary);
        }

        .csv-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        .csv-table th,
        .csv-table td {
            padding: 0.5rem;
            border: 1px solid var(--color-border);
            text-align: left;
            min-width: 100px;
        }

        .csv-table th {
            background: var(--color-bg-tertiary);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .csv-table tr:nth-child(even) {
            background: var(--color-bg-tertiary);
        }

        .csv-table tr:hover {
            background: var(--color-accent-light);
        }

        .csv-table input {
            width: 100%;
            padding: 0.25rem;
            border: 1px solid transparent;
            background: transparent;
            color: inherit;
            font-size: inherit;
            font-family: inherit;
        }

        .csv-table input:focus {
            border-color: var(--color-border-focus);
            outline: none;
            background: var(--color-bg-input);
        }

        .row-number {
            color: var(--color-text-muted);
            text-align: center;
            width: 50px;
            min-width: 50px;
            max-width: 50px;
            background: var(--color-bg-tertiary) !important;
            font-family: var(--font-mono);
            font-size: var(--font-size-xs);
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .stats-bar {
            display: flex;
            gap: 1.5rem;
            padding: 0.75rem 1rem;
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            margin-bottom: 1rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .drop-zone {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            color: var(--color-text-muted);
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            border-color: var(--color-accent);
            background: var(--color-accent-light);
        }

        .drop-zone i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>

<body>
    <div class="tool-container">
        <a href="index.html" class="nav-back"><i class="bi bi-arrow-left"></i> Back to Tools</a>

        <header class="tool-header">
            <h1><i class="bi bi-file-earmark-spreadsheet"></i> CSV Viewer/Editor</h1>
            <div class="tool-actions"></div>
        </header>

        <!-- Input Section -->
        <div class="panel csv-input-section">
            <div class="split-container">
                <div>
                    <div class="form-group">
                        <label class="form-label">Paste CSV Data</label>
                        <textarea id="csvInput" class="form-textarea code" rows="6" placeholder="Paste your CSV data here...
name,age,city
John,25,New York
Jane,30,Los Angeles"></textarea>
                    </div>
                    <button type="button" class="btn btn-primary" id="parseBtn">
                        <i class="bi bi-table"></i> Parse CSV
                    </button>
                </div>
                <div>
                    <div class="form-group">
                        <label class="form-label">Or Upload CSV File</label>
                        <div id="dropZone" class="drop-zone">
                            <i class="bi bi-cloud-upload"></i>
                            <div>Drop CSV file here or click to browse</div>
                            <input type="file" id="fileInput" accept=".csv,.tsv,.txt" style="display: none;">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 1rem;">
                        <label class="form-label">Delimiter</label>
                        <select id="delimiter" class="form-select" style="width: auto;">
                            <option value="," selected>Comma (,)</option>
                            <option value=";">Semicolon (;)</option>
                            <option value="\t">Tab</option>
                            <option value="|">Pipe (|)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Bar -->
        <div id="statsBar" class="stats-bar" style="display: none;">
            <div class="stat-item">
                <i class="bi bi-grid-3x3"></i>
                <span id="rowCount">0 rows</span>
            </div>
            <div class="stat-item">
                <i class="bi bi-layout-three-columns"></i>
                <span id="colCount">0 columns</span>
            </div>
            <div class="stat-item">
                <i class="bi bi-pencil"></i>
                <span id="editedCount">0 edited</span>
            </div>
        </div>

        <!-- Table Actions -->
        <div id="tableActions" class="table-actions" style="display: none;">
            <button type="button" class="btn btn-secondary" id="addRowBtn">
                <i class="bi bi-plus"></i> Add Row
            </button>
            <button type="button" class="btn btn-secondary" id="addColBtn">
                <i class="bi bi-plus"></i> Add Column
            </button>
            <button type="button" class="btn btn-success" id="exportBtn">
                <i class="bi bi-download"></i> Export CSV
            </button>
            <button type="button" class="btn btn-secondary" id="copyBtn">
                <i class="bi bi-clipboard"></i> Copy to Clipboard
            </button>
            <button type="button" class="btn btn-danger" id="clearTableBtn">
                <i class="bi bi-x-lg"></i> Clear
            </button>
        </div>

        <!-- Table Container -->
        <div id="tableContainer" class="table-container" style="display: none; max-height: 500px; overflow: auto;">
            <table id="csvTable" class="csv-table"></table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="shared-utils.js"></script>
    <script>
        // DOM Elements
        const csvInput = document.getElementById('csvInput');
        const parseBtn = document.getElementById('parseBtn');
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const delimiter = document.getElementById('delimiter');
        const tableContainer = document.getElementById('tableContainer');
        const csvTable = document.getElementById('csvTable');
        const statsBar = document.getElementById('statsBar');
        const tableActions = document.getElementById('tableActions');
        const rowCount = document.getElementById('rowCount');
        const colCount = document.getElementById('colCount');
        const editedCount = document.getElementById('editedCount');
        const addRowBtn = document.getElementById('addRowBtn');
        const addColBtn = document.getElementById('addColBtn');
        const exportBtn = document.getElementById('exportBtn');
        const copyBtn = document.getElementById('copyBtn');
        const clearTableBtn = document.getElementById('clearTableBtn');

        let data = [];
        let headers = [];
        let editCount = 0;

        // Initialize tool
        initTool({
            toolName: 'csv',
            onExecute: parseCSV,
            getShareData: () => ({
                csv: csvInput.value,
                delimiter: delimiter.value
            })
        });

        // Event listeners
        parseBtn.addEventListener('click', parseCSV);

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleFile(e.target.files[0]);
        });

        addRowBtn.addEventListener('click', addRow);
        addColBtn.addEventListener('click', addColumn);
        exportBtn.addEventListener('click', exportCSV);
        copyBtn.addEventListener('click', async () => {
            const csv = generateCSV();
            await copyToClipboard(csv);
            showCopyFeedback('CSV copied to clipboard!');
        });
        clearTableBtn.addEventListener('click', clearTable);

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                csvInput.value = e.target.result;
                parseCSV();
            };
            reader.readAsText(file);
        }

        function parseCSV() {
            const input = csvInput.value.trim();
            if (!input) {
                alert('Please enter CSV data');
                return;
            }

            const delim = delimiter.value === '\\t' ? '\t' : delimiter.value;

            const result = Papa.parse(input, {
                delimiter: delim,
                header: true,
                skipEmptyLines: true
            });

            if (result.errors.length > 0) {
                console.warn('Parse warnings:', result.errors);
            }

            headers = result.meta.fields || [];
            data = result.data;
            editCount = 0;

            renderTable();
            updateStats();

            tableContainer.style.display = 'block';
            statsBar.style.display = 'flex';
            tableActions.style.display = 'flex';
        }

        function renderTable() {
            if (headers.length === 0) return;

            let html = '<thead><tr><th class="row-number">#</th>';
            headers.forEach((header, i) => {
                html += `<th><input type="text" value="${escapeHtml(header)}" data-header="${i}"></th>`;
            });
            html += '</tr></thead><tbody>';

            data.forEach((row, rowIndex) => {
                html += `<tr><td class="row-number">${rowIndex + 1}</td>`;
                headers.forEach((header, colIndex) => {
                    const value = row[header] || '';
                    html += `<td><input type="text" value="${escapeHtml(value)}" data-row="${rowIndex}" data-col="${colIndex}"></td>`;
                });
                html += '</tr>';
            });

            html += '</tbody>';
            csvTable.innerHTML = html;

            // Add event listeners for editing
            csvTable.querySelectorAll('input[data-row]').forEach(input => {
                input.addEventListener('change', (e) => {
                    const row = parseInt(e.target.dataset.row);
                    const col = parseInt(e.target.dataset.col);
                    const header = headers[col];
                    data[row][header] = e.target.value;
                    editCount++;
                    updateStats();
                });
            });

            csvTable.querySelectorAll('input[data-header]').forEach(input => {
                input.addEventListener('change', (e) => {
                    const col = parseInt(e.target.dataset.header);
                    const oldHeader = headers[col];
                    const newHeader = e.target.value;

                    // Rename header in data
                    data.forEach(row => {
                        row[newHeader] = row[oldHeader];
                        delete row[oldHeader];
                    });

                    headers[col] = newHeader;
                    editCount++;
                    updateStats();
                });
            });
        }

        function updateStats() {
            rowCount.textContent = `${data.length} rows`;
            colCount.textContent = `${headers.length} columns`;
            editedCount.textContent = `${editCount} edited`;
        }

        function addRow() {
            const newRow = {};
            headers.forEach(h => newRow[h] = '');
            data.push(newRow);
            renderTable();
            updateStats();
        }

        function addColumn() {
            const colName = prompt('Enter column name:', `Column${headers.length + 1}`);
            if (colName) {
                headers.push(colName);
                data.forEach(row => row[colName] = '');
                renderTable();
                updateStats();
            }
        }

        function generateCSV() {
            const delim = delimiter.value === '\\t' ? '\t' : delimiter.value;
            return Papa.unparse(data, {
                delimiter: delim,
                columns: headers
            });
        }

        function exportCSV() {
            const csv = generateCSV();
            downloadFile(csv, 'export.csv', 'text/csv');
        }

        function clearTable() {
            data = [];
            headers = [];
            editCount = 0;
            csvTable.innerHTML = '';
            tableContainer.style.display = 'none';
            statsBar.style.display = 'none';
            tableActions.style.display = 'none';
            csvInput.value = '';
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>

</html>