<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tama Paradise: Floppa Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --shell-color: #ff9ed2; 
            --shell-gradient: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(0,0,0,0.1) 100%);
            --screen-bg: #c4f0c2; 
            --ui-bg: #333;
            --btn-color: #eee;
        }

        body {
            background-color: #222;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Press Start 2P', cursive;
            overflow: hidden;
            user-select: none;
        }

        /* SHELL DESIGN */
        .device-shell {
            background-color: var(--shell-color);
            background-image: var(--shell-gradient);
            width: 340px;
            height: 420px;
            border-radius: 45% 45% 40% 40%;
            position: relative;
            box-shadow: 
                inset -15px -15px 30px rgba(0,0,0,0.2),
                10px 10px 50px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 50px;
            border: 6px solid rgba(0,0,0,0.15);
            transition: background-color 0.5s ease;
        }

        .zoom-dial-label {
            position: absolute;
            left: -25px;
            top: 100px;
            width: 30px;
            height: 100px;
            background: #444;
            color: #fff;
            border-radius: 10px 0 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            writing-mode: vertical-rl;
            font-size: 10px;
            cursor: pointer;
            border: 1px solid #666;
        }

        .skin-btn {
            position: absolute;
            right: -30px;
            top: 250px;
            width: 40px;
            height: 40px;
            background: linear-gradient(to bottom, #f0f, #a0a);
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .screen-bezel {
            background-color: #f4f4f4;
            padding: 20px;
            border-radius: 20px;
            width: 220px;
            height: 220px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 2px 2px 10px rgba(0,0,0,0.2);
        }

        canvas {
            background-color: var(--screen-bg);
            border: 3px solid #778;
            border-radius: 6px;
            image-rendering: pixelated;
            box-shadow: inset 3px 3px 6px rgba(0,0,0,0.15);
        }

        /* BUTTONS */
        .controls-area {
            display: flex;
            justify-content: space-between;
            width: 200px;
            margin-top: 30px;
        }

        .btn-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: var(--btn-color);
            box-shadow: 0 6px 0 #999;
            cursor: pointer;
            margin-bottom: 8px;
            transition: transform 0.1s;
        }

        .btn:active {
            transform: translateY(6px);
            box-shadow: none;
        }

        .label {
            font-size: 8px;
            opacity: 0.9;
            color: rgba(255,255,255,0.8);
            text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
            font-weight: bold;
        }

        .zoom-controls {
            position: absolute;
            left: -70px;
            top: 50px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .zoom-btn {
            background: #444;
            color: white;
            border: 1px solid #666;
            padding: 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 10px;
            border-radius: 5px;
        }

        .save-bar {
            position: fixed;
            bottom: 20px;
            background: #333;
            padding: 10px 20px;
            border-radius: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            border: 1px solid #555;
            z-index: 100;
        }
        
        .save-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            font-family: inherit;
            font-size: 10px;
            cursor: pointer;
            border-radius: 4px;
        }

        .save-info { font-size: 10px; color: #aaa; }

    </style>
</head>
<body>

    <div class="device-shell" id="shell">
        <div class="zoom-dial-label">ZOOM</div>
        <button class="skin-btn" onclick="cycleSkin()" title="Change Skin">üé®</button>

        <div class="screen-bezel">
            <canvas id="gameCanvas" width="200" height="200"></canvas>
        </div>

        <div class="controls-area">
            <div class="btn-wrapper">
                <button class="btn" id="btnA"></button>
                <span class="label">A: ACTION</span>
            </div>
            <div class="btn-wrapper">
                <button class="btn" id="btnB"></button>
                <span class="label">B: SWITCH</span>
            </div>
            <div class="btn-wrapper">
                <button class="btn" id="btnC"></button>
                <span class="label">C: CHECK</span>
            </div>
        </div>

        <div class="zoom-controls">
            <button class="zoom-btn" id="zoomOut">üî≠ OUT</button>
            <button class="zoom-btn" id="zoomIn">üî¨ IN</button>
        </div>
    </div>

    <div class="save-bar">
        <button class="save-btn" onclick="saveGame()">SAVE TO URL</button>
        <span class="save-info" id="saveMsg">Ready.</span>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // --- NEW PET ROSTER ---
        const SPECIES = {
            FLOPPA: { 
                name: "BIG FLOPPA",
                egg: 'üì¶', baby: 'üê±', child: 'üòº', adult: 'üêÜ', dead: 'üíÄ' 
            },
            UNICORN: { 
                name: "UNICORN",
                egg: '‚ú®', baby: 'üê¥', child: 'ü¶Ñ', adult: 'üåà', dead: 'ü•Ä' 
            },
            AXOLOTL: { 
                name: "AXOLOTL",
                egg: 'ü´ß', baby: 'üêü', child: 'ü¶é', adult: 'üêâ', dead: 'ü¶¥' 
            },
            CAPYBARA: { 
                name: "CHILL CAPY",
                egg: 'ü••', baby: 'ü•î', child: 'üêπ', adult: 'ü¶¶', dead: 'üëª' 
            },
            PENGUIN: {
                name: "NOOT NOOT",
                egg: 'üßä', baby: 'üê§', child: 'üêß', adult: 'ü¶Ö', dead: 'üçó'
            }
        };

        const COMMON_SPRITES = {
            poop: 'üí©', meat: 'üçñ', heart: '‚ù§Ô∏è', 
            pill: 'üíä', virus: 'ü¶†', tree: 'üå≤', house: 'üè†',
            planet: 'üåç', cell: 'üß¨'
        };

        const SKINS = [
            { name: "Paradise Pink", color: "#ff9ed2", grad: "linear-gradient(135deg, rgba(255,255,255,0.4), rgba(0,0,0,0.1))" },
            { name: "Atomic Purple", color: "rgba(100, 0, 150, 0.8)", grad: "url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIiBmaWxsLW9wYWNpdHk9IjAuMSIvPgo8L3N2Zz4=')" },
            { name: "90s Teal",      color: "#00bfa5", grad: "linear-gradient(45deg, #00bfa5, #64ffda)" },
            { name: "Solid Gold",    color: "#ffd700", grad: "linear-gradient(to bottom, #ffd700, #b8860b)" },
            { name: "Floppa Orange", color: "#ff8800", grad: "linear-gradient(135deg, #ff8800, #ffbb00)" }
        ];

        const ZOOM_LEVELS = { SPACE: 0, FIELD: 1, TAMA: 2, CELL: 3 };
        const FIELD_TYPES = ['LAND', 'WATER', 'SKY'];
        
        // --- GAME STATE ---
        let state = {
            version: 3,
            zoom: ZOOM_LEVELS.TAMA,
            planetLevel: 1,
            fieldType: 'LAND',
            skinIndex: 0,
            speciesKey: 'FLOPPA', // Default

            age: 0,
            hunger: 80,
            happiness: 80,
            health: 100, 
            poopCount: 0,
            stage: 'egg',
            isDead: false,
            
            x: 100, y: 100,
            lastTick: Date.now()
        };

        // --- CONFIG ---
        const TICK_RATE = 3000; // Slow decay (Chill Mode)

        // --- CORE SYSTEMS ---
        function init() {
            const params = new URLSearchParams(window.location.search);
            const data = params.get('data');
            
            if (data) {
                try {
                    const json = atob(data);
                    const loadedState = JSON.parse(json);
                    state = { ...state, ...loadedState };
                    state.lastTick = Date.now();
                    document.getElementById('saveMsg').innerText = "Loaded!";
                } catch (e) { console.error("Corrupt Save"); }
            }

            applySkin(state.skinIndex);
            requestAnimationFrame(gameLoop);
        }

        function saveGame() {
            try {
                const json = JSON.stringify(state);
                const encoded = btoa(json);
                const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?data=' + encoded;
                window.history.pushState({path:newUrl},'',newUrl);
                document.getElementById('saveMsg').innerText = "Saved to URL!";
            } catch (e) { console.error(e); }
        }

        function cycleSkin() {
            state.skinIndex = (state.skinIndex + 1) % SKINS.length;
            applySkin(state.skinIndex);
            showMsg(SKINS[state.skinIndex].name);
        }

        function applySkin(index) {
            const shell = document.getElementById('shell');
            const style = SKINS[index];
            shell.style.setProperty('--shell-color', style.color);
            shell.style.setProperty('--shell-gradient', style.grad);
        }

        // --- LOOP ---
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function update() {
            if (state.isDead) return;

            const now = Date.now();
            if (now - state.lastTick > TICK_RATE) { 
                state.age++;
                state.lastTick = now;

                // Evolution
                if (state.stage === 'egg' && state.age > 5) { state.stage = 'baby'; showMsg("HATCHED!"); }
                if (state.stage === 'baby' && state.age > 20) { state.stage = 'child'; showMsg("EVOLVED!"); }
                if (state.stage === 'child' && state.age > 100) { state.stage = 'adult'; showMsg("GROWN!"); }

                if (state.stage !== 'egg') {
                    state.hunger = Math.max(0, state.hunger - 1); 
                    if (state.age % 2 === 0) state.happiness = Math.max(0, state.happiness - 1);
                    
                    if (Math.random() < 0.03) state.poopCount++;

                    // Disease Check
                    if (state.poopCount > 3 && Math.random() < 0.05) {
                        state.health = Math.max(0, state.health - 5);
                    }

                    if (state.hunger <= 0 || state.health <= 0) {
                        state.isDead = true;
                        state.stage = 'dead';
                        showMsg("RIP");
                    }
                }
                
                // Walking
                if (Math.random() > 0.5) {
                    state.x = Math.max(20, Math.min(180, state.x + (Math.random() * 20 - 10)));
                    state.y = Math.max(20, Math.min(180, state.y + (Math.random() * 20 - 10)));
                }
            }
        }

        // --- RENDERER ---
        function draw() {
            ctx.fillStyle = getComputedStyle(canvas).backgroundColor;
            ctx.fillRect(0, 0, 200, 200);

            switch(state.zoom) {
                case ZOOM_LEVELS.SPACE: drawSpace(); break;
                case ZOOM_LEVELS.FIELD: drawField(); break;
                case ZOOM_LEVELS.TAMA:  drawTama(); break;
                case ZOOM_LEVELS.CELL:  drawCell(); break;
            }

            if (state.zoom !== ZOOM_LEVELS.SPACE) drawHUD();
            drawOverlay();
        }

        function getSprite(key) {
            return SPECIES[state.speciesKey][key] || COMMON_SPRITES[key];
        }

        // VIEW 0: SPACE (Selection)
        function drawSpace() {
            ctx.fillStyle = "#111";
            ctx.fillRect(0, 0, 200, 200);
            
            // Stars
            ctx.fillStyle = "#fff";
            for(let i=0; i<15; i++) { ctx.fillRect((state.age*i)%200, (i*40)%200, 2, 2); }

            ctx.textAlign = "center";
            ctx.fillStyle = "#fff";
            ctx.font = "10px 'Press Start 2P'";
            ctx.fillText("PLANET SELECT", 100, 30);
            
            ctx.font = "60px Arial";
            ctx.fillText(COMMON_SPRITES.planet, 100, 80);

            // Current Species Info
            ctx.font = "10px 'Press Start 2P'";
            ctx.fillStyle = "#4ff";
            ctx.fillText("< " + SPECIES[state.speciesKey].name + " >", 100, 130);
            
            // Show preview of adult form
            ctx.font = "20px Arial";
            ctx.fillText(SPECIES[state.speciesKey].adult, 100, 150);

            ctx.fillStyle = "#aaa";
            ctx.font = "8px 'Press Start 2P'";
            ctx.fillText("BTN A: FIELD TYPE", 100, 175);
            ctx.fillText("BTN B: CHANGE PET", 100, 190);
        }

        // VIEW 1: FIELD
        function drawField() {
            ctx.font = "20px Arial";
            if (state.fieldType === 'LAND') {
                ctx.fillText(COMMON_SPRITES.tree, 30, 40);
                ctx.fillText(COMMON_SPRITES.house, 100, 40);
            } else if (state.fieldType === 'WATER') {
                ctx.fillText('üåä', 30, 50); ctx.fillText('üèùÔ∏è', 150, 150);
            } else {
                ctx.fillText('‚òÅÔ∏è', 30, 50); ctx.fillText('‚ú®', 150, 150);
            }

            for(let i=0; i<state.poopCount; i++) {
                ctx.fillText(COMMON_SPRITES.poop, 40 + (i*20), 160);
            }

            if (!state.isDead) {
                ctx.font = "20px Arial";
                ctx.fillText(getSprite(state.stage), state.x, state.y);
            }
            
            ctx.fillStyle = "#000";
            ctx.textAlign = "left";
            ctx.font = "8px 'Press Start 2P'";
            ctx.fillText("FIELD: " + state.fieldType, 5, 15);
        }

        // VIEW 2: TAMA (Main)
        function drawTama() {
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            let bob = Math.sin(Date.now() / 400) * 5; 
            
            ctx.font = "80px Arial";
            let sprite = state.isDead ? getSprite('dead') : getSprite(state.stage);
            ctx.fillText(sprite, 100, 100 + bob);

            if (state.hunger < 30 && !state.isDead) ctx.fillText("üí≠üçñ", 150, 60);
        }

        // VIEW 3: CELL
        function drawCell() {
            ctx.strokeStyle = "rgba(0,100,0,0.2)";
            ctx.beginPath();
            for(let i=0; i<200; i+=10) { ctx.moveTo(i,0); ctx.lineTo(i,200); ctx.moveTo(0,i); ctx.lineTo(200,i); }
            ctx.stroke();

            ctx.textAlign = "center";
            ctx.fillStyle = "#005500";
            ctx.font = "10px 'Press Start 2P'";
            ctx.fillText("HEALTH SCAN", 100, 20);

            ctx.font = "30px Arial";
            ctx.fillText(COMMON_SPRITES.cell, 80, 80);
            ctx.fillText(COMMON_SPRITES.cell, 120, 120);
            
            ctx.fillStyle = "#555";
            ctx.fillRect(40, 160, 120, 10);
            ctx.fillStyle = state.health > 50 ? "lime" : "red";
            ctx.fillRect(40, 160, (state.health/100)*120, 10);
        }

        function drawHUD() {
            ctx.fillStyle = "#000";
            ctx.font = "10px 'Press Start 2P'";
            ctx.textAlign = "left";
            ctx.fillText(COMMON_SPRITES.meat + Math.floor(state.hunger), 5, 195);
            ctx.textAlign = "right";
            ctx.fillText(COMMON_SPRITES.heart + Math.floor(state.happiness), 195, 195);
        }

        function drawOverlay() {
            if (msgTimer > 0) {
                ctx.fillStyle = "rgba(0,0,0,0.8)";
                ctx.fillRect(0, 80, 200, 40);
                ctx.fillStyle = "#fff";
                ctx.font = "10px 'Press Start 2P'";
                ctx.textAlign = "center";
                ctx.fillText(currentMsg, 100, 105);
                msgTimer--;
            }
        }

        // --- CONTROLS ---
        let currentMsg = "";
        let msgTimer = 0;
        function showMsg(txt) { currentMsg = txt; msgTimer = 60; }

        document.getElementById('zoomIn').onclick = () => { if(state.zoom < 3) state.zoom++; };
        document.getElementById('zoomOut').onclick = () => { if(state.zoom > 0) state.zoom--; };

        document.getElementById('btnA').onclick = () => {
            if (state.isDead) return;
            if (state.zoom === ZOOM_LEVELS.SPACE) {
                let idx = FIELD_TYPES.indexOf(state.fieldType);
                state.fieldType = FIELD_TYPES[(idx + 1) % FIELD_TYPES.length];
                showMsg(state.fieldType);
            } else if (state.zoom === ZOOM_LEVELS.FIELD) {
                if (state.poopCount > 0) { state.poopCount--; state.happiness+=5; showMsg("CLEANED"); }
            } else if (state.zoom === ZOOM_LEVELS.TAMA) {
                if (state.hunger < 100) { state.hunger += 20; showMsg("YUMMY"); }
            } else if (state.zoom === ZOOM_LEVELS.CELL) {
                if (state.health < 100) { state.health += 20; showMsg("CURED"); }
            }
        };

        document.getElementById('btnB').onclick = () => {
            if (state.isDead) return;
            
            // SPECIES SWITCHING
            if (state.zoom === ZOOM_LEVELS.SPACE) {
                const keys = Object.keys(SPECIES);
                let currentIdx = keys.indexOf(state.speciesKey);
                state.speciesKey = keys[(currentIdx + 1) % keys.length];
                showMsg(SPECIES[state.speciesKey].name);
            }
            
            else if (state.zoom === ZOOM_LEVELS.TAMA) {
                state.happiness = Math.min(100, state.happiness + 15);
                state.hunger -= 5; 
                showMsg("PLAY!");
            }
        };

        document.getElementById('btnC').onclick = () => {
            showMsg("AGE: " + Math.floor(state.age));
        };

        init();
    </script>
</body>
</html>