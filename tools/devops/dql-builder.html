<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DQL Query Builder</title>
    <link rel="icon" type="image/svg+xml" href="../../assets/images/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for the textarea */
        textarea::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        textarea::-webkit-scrollbar-track {
            background: #0f172a;
        }

        textarea::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        textarea::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .transition-transform {
            transition-property: transform;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 150ms;
        }

        /* Shared Utils Styles Adaptation */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 150ms;
            cursor: pointer;
        }

        .btn-secondary {
            background-color: white;
            border: 1px solid #e2e8f0;
            /* slate-200 */
            color: #475569;
            /* slate-600 */
        }

        .btn-secondary:hover {
            background-color: #f8fafc;
            /* slate-50 */
        }

        /* Theme toggle specific */
        .theme-toggle {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: 1px solid #e2e8f0;
            cursor: pointer;
        }

        .theme-toggle:hover {
            background-color: #f8fafc;
        }

        .theme-toggle .icon-sun,
        .theme-toggle .icon-moon {
            transition: opacity 0.2s ease;
        }

        [data-theme="dark"] .theme-toggle .icon-sun {
            display: inline;
        }

        [data-theme="dark"] .theme-toggle .icon-moon {
            display: none;
        }

        [data-theme="light"] .theme-toggle .icon-sun,
        :root:not([data-theme]) .theme-toggle .icon-sun {
            display: none;
        }

        [data-theme="light"] .theme-toggle .icon-moon,
        :root:not([data-theme]) .theme-toggle .icon-moon {
            display: inline;
        }

        /* History Dropdown */
        .history-dropdown {
            position: relative;
        }

        .history-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }

        .history-menu.show {
            display: block;
        }

        .history-item {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            color: #334155;
            border-bottom: 1px solid #f1f5f9;
        }

        .history-item:hover {
            background-color: #f8fafc;
        }

        .btn-icon {
            width: 2.5rem;
            height: 2.5rem;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Copy feedback */
        .copy-feedback {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background-color: #10b981;
            /* emerald-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(100px);
            opacity: 0;
            transition: all 300ms;
            z-index: 100;
        }

        .copy-feedback.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Manual Override Mode */
        .manual-mode-indicator {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
            }

            50% {
                box-shadow: 0 0 0 6px rgba(245, 158, 11, 0);
            }
        }

        .output-editable {
            border: 2px solid #f59e0b !important;
            background: linear-gradient(to bottom, #1e1b4b, #0f172a) !important;
        }

        /* Preset dropdown */
        .preset-dropdown {
            position: relative;
        }

        .preset-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 0.5rem;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            min-width: 220px;
            z-index: 50;
            display: none;
        }

        .dark .preset-menu {
            background-color: #1e293b;
            border-color: #334155;
        }

        .preset-menu.show {
            display: block;
        }

        .preset-item {
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
            color: #334155;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
        }

        .dark .preset-item {
            color: #cbd5e1;
            border-color: #334155;
        }

        .preset-item:hover {
            background-color: #f8fafc;
        }

        .dark .preset-item:hover {
            background-color: #334155;
        }

        .preset-item-name {
            font-weight: 600;
        }

        .preset-item-desc {
            font-size: 0.75rem;
            color: #64748b;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem 0.75rem;
            background-color: #1e293b;
            color: white;
            font-size: 0.75rem;
            border-radius: 0.375rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            pointer-events: none;
            z-index: 100;
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Keyboard shortcut badge */
        .kbd {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.375rem;
            font-size: 0.65rem;
            font-family: monospace;
            background: #1e293b;
            color: #94a3b8;
            border: 1px solid #334155;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
        }
    </style>
</head>

<body
    class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 font-sans min-h-screen p-4 transition-colors duration-200">

    <div class="max-w-7xl mx-auto space-y-6">

        <a href="../../index.html"
            class="flex items-center space-x-1 text-slate-500 hover:text-blue-600 text-sm transition-colors">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
            <span>Back to Tools</span>
        </a>

        <!-- Header -->
        <header class="flex items-center justify-between pb-4 border-b border-slate-200 dark:border-slate-700">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-600 p-2 rounded-lg text-white">
                    <i data-lucide="terminal" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-900 dark:text-white">DQL Query Builder</h1>
                    <p class="text-slate-500 text-sm">Generate standardized Dynatrace log queries for API Factory</p>
                </div>
            </div>
            <div class="tool-actions flex items-center space-x-2"></div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- LEFT COLUMN: Builder Controls -->
            <div class="space-y-6">

                <!-- Toolbar -->
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-3 flex flex-wrap items-center gap-2">
                    <!-- Presets Dropdown -->
                    <div class="preset-dropdown">
                        <button id="presetBtn" class="btn btn-secondary text-xs">
                            <i data-lucide="bookmark" class="w-3 h-3 mr-1"></i>
                            Presets
                            <i data-lucide="chevron-down" class="w-3 h-3 ml-1"></i>
                        </button>
                        <div id="presetMenu" class="preset-menu">
                            <div class="preset-item" data-preset="error-logs">
                                <span class="preset-item-name">üî¥ Error Logs</span>
                                <span class="preset-item-desc">Filter for error status codes</span>
                            </div>
                            <div class="preset-item" data-preset="performance">
                                <span class="preset-item-name">‚ö° Performance Analysis</span>
                                <span class="preset-item-desc">Show timing and response data</span>
                            </div>
                            <div class="preset-item" data-preset="api-trace">
                                <span class="preset-item-name">üîç API Trace</span>
                                <span class="preset-item-desc">Full request/response tracing</span>
                            </div>
                            <div class="preset-item" data-preset="kafka">
                                <span class="preset-item-name">üì® Kafka Listener</span>
                                <span class="preset-item-desc">Kafka topic listener logs</span>
                            </div>
                            <div class="preset-item" data-preset="db">
                                <span class="preset-item-name">üóÑÔ∏è Database Queries</span>
                                <span class="preset-item-desc">DB and DataSource logs</span>
                            </div>
                        </div>
                    </div>

                    <div class="h-6 w-px bg-slate-200 dark:bg-slate-600"></div>

                    <!-- Reset Button -->
                    <button id="resetBtn" class="btn btn-secondary text-xs tooltip"
                        data-tooltip="Reset to defaults (Ctrl+Shift+R)">
                        <i data-lucide="rotate-ccw" class="w-3 h-3 mr-1"></i>
                        Reset
                    </button>

                    <!-- Export/Import -->
                    <button id="exportBtn" class="btn btn-secondary text-xs tooltip"
                        data-tooltip="Export configuration as JSON">
                        <i data-lucide="download" class="w-3 h-3 mr-1"></i>
                        Export
                    </button>
                    <button id="importBtn" class="btn btn-secondary text-xs tooltip"
                        data-tooltip="Import configuration from JSON">
                        <i data-lucide="upload" class="w-3 h-3 mr-1"></i>
                        Import
                    </button>
                    <input type="file" id="importFileInput" accept=".json" class="hidden">

                    <div class="flex-1"></div>

                    <!-- Keyboard Shortcuts Help -->
                    <button id="shortcutsHelpBtn" class="btn btn-secondary btn-icon text-xs tooltip"
                        data-tooltip="Keyboard shortcuts">
                        <i data-lucide="keyboard" class="w-4 h-4"></i>
                    </button>
                </div>

                <!-- Block 1: Source & Time -->
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div
                        class="bg-slate-50 dark:bg-slate-800/50 px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center space-x-2">
                        <i data-lucide="filter" class="w-4 h-4 text-blue-500"></i>
                        <h2 class="font-semibold text-slate-700 dark:text-slate-200">1. Log Source & Time</h2>
                    </div>
                    <div class="p-4 space-y-4">

                        <!-- Time Selection -->
                        <div
                            class="bg-slate-50 dark:bg-slate-900 p-3 rounded-lg border border-slate-200 dark:border-slate-700 space-y-3">
                            <div class="flex items-center space-x-2 mb-2">
                                <i data-lucide="clock" class="w-4 h-4 text-slate-500"></i>
                                <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Time
                                    Range</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2" id="timeModeButtons">
                                <button data-mode="none"
                                    class="text-xs py-1.5 px-2 rounded border transition-colors bg-blue-50 border-blue-200 text-blue-700 font-medium">Default</button>
                                <button data-mode="relative"
                                    class="text-xs py-1.5 px-2 rounded border transition-colors bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700">Last
                                    X Hours</button>
                                <button data-mode="range"
                                    class="text-xs py-1.5 px-2 rounded border transition-colors bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700">Date
                                    Range</button>
                            </div>

                            <!-- Relative Time Input -->
                            <div id="relativeTimeContainer" class="hidden flex items-center space-x-2 mt-2">
                                <span class="text-sm text-slate-600 dark:text-slate-400">Last</span>
                                <input type="number" id="relativeTimeInput" min="1" value="2"
                                    class="w-16 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-sm rounded p-1 text-center">
                                <span class="text-sm text-slate-600 dark:text-slate-400">hours</span>
                            </div>

                            <!-- Date Range Inputs -->
                            <div id="rangeTimeContainer" class="hidden grid grid-cols-1 gap-2 mt-2">
                                <div>
                                    <label class="text-xs text-slate-500 block mb-1">From (ISO Timestamp)</label>
                                    <input type="text" id="startTimeInput" placeholder="2023-10-27T08:00:00"
                                        class="w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-xs rounded p-1.5 font-mono">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500 block mb-1">To (ISO Timestamp)</label>
                                    <input type="text" id="endTimeInput" placeholder="2023-10-27T10:00:00"
                                        class="w-full bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-xs rounded p-1.5 font-mono">
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-slate-100 dark:border-slate-700 pt-3">
                            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">K8s
                                Namespace</label>
                            <select id="namespaceSelect"
                                class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 font-mono">
                                <option value="api-factory-dev">api-factory-dev</option>
                                <option value="api-factory-sit">api-factory-sit</option>
                                <option value="api-factory-uat" selected>api-factory-uat</option>
                                <option value="Custom">Custom</option>
                            </select>
                            <input type="text" id="customNamespaceInput"
                                class="hidden mt-2 w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 font-mono"
                                placeholder="Enter Custom Namespace">
                        </div>
                        <div>
                            <label
                                class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Content
                                Path / API Pattern</label>
                            <input type="text" id="contentPathInput"
                                value="*/rest/api/v1/corporateServices/directDebit/refund/confirmation*"
                                class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 font-mono"
                                placeholder="e.g. */rest/api/v1/...">
                        </div>
                    </div>
                </div>

                <!-- Block 2: Additional Filters -->
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div
                        class="bg-slate-50 dark:bg-slate-800/50 px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="settings" class="w-4 h-4 text-purple-500"></i>
                            <h2 class="font-semibold text-slate-700 dark:text-slate-200">2. Extra Filters</h2>
                        </div>
                        <button id="addPhraseBtn"
                            class="text-xs bg-white dark:bg-slate-700 hover:bg-slate-100 dark:hover:bg-slate-600 border border-slate-300 dark:border-slate-600 dark:text-slate-200 px-2 py-1 rounded flex items-center transition-colors">
                            <i data-lucide="plus" class="w-3 h-3 mr-1"></i> Add Filter
                        </button>
                    </div>
                    <div id="phrasesContainer" class="p-4 space-y-3">
                        <!-- Phrases will be injected here via JS -->
                    </div>
                </div>

                <!-- Block 3: Logic & Fields -->
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div
                        class="bg-slate-50 dark:bg-slate-800/50 px-4 py-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <i data-lucide="code" class="w-4 h-4 text-green-600"></i>
                            <h2 class="font-semibold text-slate-700 dark:text-slate-200">3. App Logic & Output</h2>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-xs text-slate-600 dark:text-slate-400 font-medium cursor-pointer"
                                for="parsingToggle">Standard Parsing</label>
                            <div id="parsingToggle"
                                class="w-8 h-4 rounded-full p-0.5 cursor-pointer transition-colors bg-green-500">
                                <div
                                    class="w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform translate-x-4">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="logicContainer" class="divide-y divide-slate-100 dark:divide-slate-700">
                        <!-- Logic Section -->
                        <div class="p-4 space-y-4">
                            <!-- Performance Toggle -->
                            <div
                                class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-900/50 rounded-lg p-3 flex items-start space-x-3">
                                <i data-lucide="zap" class="w-5 h-5 text-amber-500 mt-0.5 flex-shrink-0"></i>
                                <div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm font-semibold text-amber-900 dark:text-amber-100">Smart
                                            Optimization</span>
                                        <div id="optToggle"
                                            class="w-8 h-4 rounded-full p-0.5 cursor-pointer transition-colors bg-amber-500">
                                            <div
                                                class="w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform translate-x-4">
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-xs text-amber-800 dark:text-amber-200/70 mt-1 leading-relaxed">
                                        Adds coarse text filters <em>before</em> parsing.
                                    </p>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="col-span-1 md:col-span-2">
                                    <label
                                        class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Service
                                        Type</label>
                                    <select id="serviceTypeSelect"
                                        class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                                        <option value="SELF" selected>SELF</option>
                                        <option value="DB">DB</option>
                                        <option value="DataSource">DataSource</option>
                                        <option value="KAFKA-TOPIC-LISTENER">KAFKA-TOPIC-LISTENER</option>
                                        <option value="PUBSUB-QUEUE-LISTENER">PUBSUB-QUEUE-LISTENER</option>
                                        <option value="RestTemplate">RestTemplate</option>
                                        <option value="RestTemplate-Annotation">RestTemplate-Annotation</option>
                                        <option value="RestTemplate-Annotation-Proxy">RestTemplate-Annotation-Proxy
                                        </option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                    <input type="text" id="customServiceTypeInput"
                                        class="hidden mt-2 w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"
                                        placeholder="Enter Custom Service Type">
                                </div>

                                <div>
                                    <label
                                        class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Service
                                        Name</label>
                                    <input type="text" id="serviceNameInput"
                                        class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"
                                        placeholder="Optional">
                                </div>

                                <div>
                                    <label
                                        class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Status
                                        Code</label>
                                    <input type="text" id="statusCodeInput"
                                        class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5"
                                        placeholder="Optional">
                                </div>
                            </div>
                        </div>

                        <!-- Fields Section -->
                        <div class="p-4 bg-slate-50 dark:bg-slate-900">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center space-x-2">
                                    <i data-lucide="columns" class="w-4 h-4 text-blue-500"></i>
                                    <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-200">Output Fields
                                    </h3>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <button id="selectAllFieldsBtn"
                                        class="text-xs px-2 py-1 rounded bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors">
                                        All
                                    </button>
                                    <button id="deselectAllFieldsBtn"
                                        class="text-xs px-2 py-1 rounded bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                                        None
                                    </button>
                                </div>
                            </div>
                            <div id="fieldsContainer" class="grid grid-cols-2 gap-2">
                                <!-- Fields injected via JS -->
                            </div>
                        </div>
                    </div>
                    <!-- Disabled State -->
                    <div id="parsingDisabledMsg" class="hidden p-8 text-center text-slate-400 text-sm">
                        Standard JSON parsing disabled. Query will return raw logs.
                    </div>
                </div>

                <!-- Block 4: Output Options -->
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-4 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <div class="flex items-center space-x-3">
                        <span class="text-sm font-semibold text-slate-700 dark:text-slate-200">Sort Order</span>
                        <div class="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                            <button id="sortDescBtn"
                                class="px-3 py-1.5 text-xs font-medium rounded-md transition-all bg-white shadow text-blue-600">Newest
                                First</button>
                            <button id="sortAscBtn"
                                class="px-3 py-1.5 text-xs font-medium rounded-md transition-all text-slate-500 dark:text-slate-300 hover:text-slate-700">Oldest
                                First</button>
                        </div>
                    </div>

                    <div class="flex items-center space-x-3">
                        <span class="text-sm font-semibold text-slate-700 dark:text-slate-200">Record Limit</span>
                        <input type="number" id="limitInput" value="40"
                            class="w-24 bg-slate-50 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 text-slate-900 dark:text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 text-center">
                    </div>
                </div>

            </div>

            <!-- RIGHT COLUMN: Output -->
            <div class="flex flex-col h-full">
                <div id="outputContainer"
                    class="bg-slate-900 rounded-xl shadow-lg overflow-hidden flex flex-col min-h-[600px] h-[85vh] lg:sticky lg:top-6">
                    <div
                        class="bg-slate-800 px-4 py-3 flex flex-wrap justify-between items-center gap-2 border-b border-slate-700">
                        <div class="flex items-center space-x-2">
                            <span class="text-slate-300 font-mono text-sm flex items-center">
                                <i data-lucide="terminal" class="w-4 h-4 mr-2"></i>
                                DQL Output
                            </span>
                            <span id="manualModeIndicator" class="manual-mode-indicator hidden">
                                <i data-lucide="edit-3" class="w-3 h-3"></i>
                                Manual Mode
                            </span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <!-- Manual Override Toggle -->
                            <label class="flex items-center space-x-2 cursor-pointer select-none">
                                <span class="text-xs text-slate-400">Manual Edit</span>
                                <div id="manualOverrideToggle"
                                    class="w-8 h-4 rounded-full p-0.5 cursor-pointer transition-colors bg-slate-600">
                                    <div
                                        class="w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform translate-x-0">
                                    </div>
                                </div>
                            </label>
                            <div class="h-4 w-px bg-slate-600"></div>
                            <!-- Download Button -->
                            <button id="downloadBtn"
                                class="flex items-center space-x-1 text-xs px-3 py-1.5 rounded-md transition-all bg-slate-700 text-slate-300 hover:bg-slate-600 tooltip"
                                data-tooltip="Download as .dql file">
                                <i data-lucide="file-down" class="w-3 h-3"></i>
                                <span>Download</span>
                            </button>
                            <!-- Copy Button -->
                            <button id="copyBtn"
                                class="flex items-center space-x-1 text-xs px-3 py-1.5 rounded-md transition-all bg-slate-700 text-slate-300 hover:bg-slate-600">
                                <i data-lucide="copy" class="w-3 h-3"></i>
                                <span id="copyBtnText">Copy</span>
                                <span class="kbd">Ctrl+C</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 p-0 overflow-hidden relative group">
                        <textarea id="outputArea" readonly
                            class="w-full h-full bg-slate-900 text-blue-200 font-mono text-sm p-4 outline-none resize-none leading-relaxed"
                            spellcheck="false"></textarea>
                    </div>
                    <div
                        class="bg-slate-800 px-4 py-2 text-xs text-slate-500 border-t border-slate-700 flex justify-between items-center">
                        <span id="outputStatus">Auto-generated based on inputs</span>
                        <div class="flex items-center space-x-4">
                            <span id="charCount">0 chars</span>
                            <span id="lineCount">0 lines</span>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Application Logic -->
    <script>
        // --- State ---
        const state = {
            namespace: "api-factory-uat",
            customNamespace: "",
            contentPath: "*/rest/api/v1/corporateServices/directDebit/refund/confirmation*",
            timeMode: "none", // none, relative, range
            relativeTime: 2,
            startTime: "",
            endTime: "",
            phrases: [
                { id: 1, value: "middleName", enabled: false, isWildcard: false },
                { id: 2, value: "4410002", enabled: false, isWildcard: false }
            ],
            parsingEnabled: true,
            optimizationEnabled: true,
            serviceType: "SELF",
            customServiceType: "",
            serviceName: "",
            statusCode: "",
            sortOrder: "desc",
            limit: 40,
            manualOverrideEnabled: false,
            outputFields: [
                { id: 'timestamp', label: 'timestamp', expression: '', enabled: true },
                { id: 'content', label: 'content (Raw Log)', expression: '', enabled: true },
                { id: 'trace_id', label: 'trace_id', expression: 'jcontent[traceId]', enabled: true },
                { id: 'serviceType', label: 'serviceType', expression: 'jmessage[serviceType]', enabled: true },
                { id: 'serviceName', label: 'serviceName', expression: 'jmessage[serviceName]', enabled: true },
                { id: 'statusCode', label: 'statusCode', expression: 'jmessage[statusCode]', enabled: true },
                { id: 'message', label: 'message', expression: 'jcontent[message]', enabled: true },
                { id: 'springAppName', label: 'springAppName', expression: 'jcontent[springAppName]', enabled: true },
                { id: 'requestData', label: 'requestData', expression: 'jmessage[requestData]', enabled: true },
                { id: 'responseData', label: 'responseData', expression: 'jmessage[responseData]', enabled: true },
            ]
        };

        // --- Default State (for reset) ---
        const defaultState = JSON.parse(JSON.stringify(state));

        // --- DOM Elements ---
        const els = {
            timeBtns: document.querySelectorAll('#timeModeButtons button'),
            relativeTimeContainer: document.getElementById('relativeTimeContainer'),
            relativeTimeInput: document.getElementById('relativeTimeInput'),
            rangeTimeContainer: document.getElementById('rangeTimeContainer'),
            startTimeInput: document.getElementById('startTimeInput'),
            endTimeInput: document.getElementById('endTimeInput'),
            namespaceSelect: document.getElementById('namespaceSelect'),
            customNamespaceInput: document.getElementById('customNamespaceInput'),
            contentPathInput: document.getElementById('contentPathInput'),
            phrasesContainer: document.getElementById('phrasesContainer'),
            addPhraseBtn: document.getElementById('addPhraseBtn'),
            parsingToggle: document.getElementById('parsingToggle'),
            optToggle: document.getElementById('optToggle'),
            logicContainer: document.getElementById('logicContainer'),
            parsingDisabledMsg: document.getElementById('parsingDisabledMsg'),
            serviceTypeSelect: document.getElementById('serviceTypeSelect'),
            customServiceTypeInput: document.getElementById('customServiceTypeInput'),
            serviceNameInput: document.getElementById('serviceNameInput'),
            statusCodeInput: document.getElementById('statusCodeInput'),
            fieldsContainer: document.getElementById('fieldsContainer'),
            sortDescBtn: document.getElementById('sortDescBtn'),
            sortAscBtn: document.getElementById('sortAscBtn'),
            limitInput: document.getElementById('limitInput'),
            outputArea: document.getElementById('outputArea'),
            outputContainer: document.getElementById('outputContainer'),
            copyBtn: document.getElementById('copyBtn'),
            copyBtnText: document.getElementById('copyBtnText'),
            lineCount: document.getElementById('lineCount'),
            charCount: document.getElementById('charCount'),
            outputStatus: document.getElementById('outputStatus'),
            // New toolbar elements
            presetBtn: document.getElementById('presetBtn'),
            presetMenu: document.getElementById('presetMenu'),
            resetBtn: document.getElementById('resetBtn'),
            exportBtn: document.getElementById('exportBtn'),
            importBtn: document.getElementById('importBtn'),
            importFileInput: document.getElementById('importFileInput'),
            shortcutsHelpBtn: document.getElementById('shortcutsHelpBtn'),
            // Manual override
            manualOverrideToggle: document.getElementById('manualOverrideToggle'),
            manualModeIndicator: document.getElementById('manualModeIndicator'),
            downloadBtn: document.getElementById('downloadBtn'),
            // Field presets
            selectAllFieldsBtn: document.getElementById('selectAllFieldsBtn'),
            deselectAllFieldsBtn: document.getElementById('deselectAllFieldsBtn')
        };

        // --- Render Functions ---

        function renderTimeUI() {
            // Update buttons style
            els.timeBtns.forEach(btn => {
                const mode = btn.dataset.mode;
                if (mode === state.timeMode) {
                    btn.className = "text-xs py-1.5 px-2 rounded border transition-colors bg-blue-50 border-blue-200 text-blue-700 font-medium";
                } else {
                    btn.className = "text-xs py-1.5 px-2 rounded border transition-colors bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700";
                }
            });

            // Show/Hide Inputs
            els.relativeTimeContainer.classList.add('hidden');
            els.rangeTimeContainer.classList.add('hidden');

            if (state.timeMode === 'relative') {
                els.relativeTimeContainer.classList.remove('hidden');
            } else if (state.timeMode === 'range') {
                els.rangeTimeContainer.classList.remove('hidden');
            }
        }

        function renderNamespaceUI() {
            if (state.namespace === "Custom") {
                els.customNamespaceInput.classList.remove('hidden');
            } else {
                els.customNamespaceInput.classList.add('hidden');
            }
        }

        function renderServiceUI() {
            if (state.serviceType === "Custom") {
                els.customServiceTypeInput.classList.remove('hidden');
            } else {
                els.customServiceTypeInput.classList.add('hidden');
            }
        }

        function renderToggle(element, enabled, activeClass = "bg-green-500", inactiveClass = "bg-slate-300") {
            const circle = element.querySelector('div');
            if (enabled) {
                element.className = `w-8 h-4 rounded-full p-0.5 cursor-pointer transition-colors ${activeClass}`;
                circle.className = `w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform translate-x-4`;
            } else {
                element.className = `w-8 h-4 rounded-full p-0.5 cursor-pointer transition-colors ${inactiveClass}`;
                circle.className = `w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform translate-x-0`;
            }
        }

        function renderParsingUI() {
            renderToggle(els.parsingToggle, state.parsingEnabled, "bg-green-500");
            renderToggle(els.optToggle, state.optimizationEnabled, "bg-amber-500");

            if (state.parsingEnabled) {
                els.logicContainer.classList.remove('hidden');
                els.parsingDisabledMsg.classList.add('hidden');
            } else {
                els.logicContainer.classList.add('hidden');
                els.parsingDisabledMsg.classList.remove('hidden');
            }
        }

        function renderPhrases() {
            els.phrasesContainer.innerHTML = '';

            if (state.phrases.length === 0) {
                els.phrasesContainer.innerHTML = `<p class="text-sm text-slate-400 italic">No extra phrase filters added.</p>`;
                return;
            }

            state.phrases.forEach(p => {
                const row = document.createElement('div');
                row.className = "flex flex-col sm:flex-row sm:items-center gap-2 p-2 bg-slate-50 dark:bg-slate-900 rounded-lg border border-slate-100 dark:border-slate-700";

                row.innerHTML = `
                    <div class="flex items-center space-x-2 flex-1">
                      <input type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500" ${p.enabled ? 'checked' : ''} onchange="updatePhrase(${p.id}, 'enabled', this.checked)">
                      <input type="text" value="${p.value}" class="w-full border text-sm rounded-lg p-2 font-mono ${p.enabled ? 'bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 dark:text-white' : 'bg-slate-100 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-400'}" placeholder="Search phrase" oninput="updatePhrase(${p.id}, 'value', this.value)">
                    </div>
                    <div class="flex items-center justify-between sm:justify-end space-x-2 pl-6 sm:pl-0">
                      <label class="flex items-center space-x-1 cursor-pointer select-none">
                        <input type="checkbox" class="w-3 h-3 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500" ${p.isWildcard ? 'checked' : ''} onchange="updatePhrase(${p.id}, 'isWildcard', this.checked)">
                        <span class="text-xs text-slate-500 font-medium whitespace-nowrap">Wildcard (*)</span>
                      </label>
                      <button onclick="removePhrase(${p.id})" class="text-slate-400 hover:text-red-500 p-1">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                      </button>
                    </div>
                `;
                els.phrasesContainer.appendChild(row);
            });
            lucide.createIcons();
        }

        function renderFields() {
            els.fieldsContainer.innerHTML = '';
            state.outputFields.forEach(f => {
                const label = document.createElement('label');
                label.className = "flex items-center space-x-2 cursor-pointer p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors";
                label.innerHTML = `
                    <input type="checkbox" class="w-4 h-4 text-blue-600 bg-white border-gray-300 rounded focus:ring-blue-500" ${f.enabled ? 'checked' : ''} onchange="toggleField('${f.id}')">
                    <span class="text-xs font-mono ${f.enabled ? 'text-slate-800 dark:text-slate-200' : 'text-slate-400'}">${f.label}</span>
                `;
                els.fieldsContainer.appendChild(label);
            });
        }

        function renderSortUI() {
            const activeClass = "bg-white dark:bg-slate-800 shadow text-blue-600 dark:text-blue-400";
            const inactiveClass = "text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200";

            if (state.sortOrder === 'desc') {
                els.sortDescBtn.className = `px-3 py-1.5 text-xs font-medium rounded-md transition-all ${activeClass}`;
                els.sortAscBtn.className = `px-3 py-1.5 text-xs font-medium rounded-md transition-all ${inactiveClass}`;
            } else {
                els.sortDescBtn.className = `px-3 py-1.5 text-xs font-medium rounded-md transition-all ${inactiveClass}`;
                els.sortAscBtn.className = `px-3 py-1.5 text-xs font-medium rounded-md transition-all ${activeClass}`;
            }
        }

        // --- Logic & Generation ---

        function generateDQL() {
            // Skip auto-generation if manual override is enabled
            if (state.manualOverrideEnabled) {
                updateOutputStats();
                return;
            }

            let dql = `fetch logs`;

            // Time Logic
            if (state.timeMode === "relative") {
                dql += `, from: -${state.relativeTime}h`;
            } else if (state.timeMode === "range") {
                if (state.startTime) dql += `, from: "${state.startTime}"`;
                if (state.endTime) dql += `, to: "${state.endTime}"`;
            }
            dql += `\n`;

            // Namespace
            const activeNamespace = state.namespace === "Custom" ? state.customNamespace : state.namespace;
            if (activeNamespace) {
                dql += `| filter matchesValue(k8s.namespace.name, "${activeNamespace}")\n`;
            }

            // Content Path
            if (state.contentPath) {
                dql += `| filter matchesValue(content, "${state.contentPath}")\n`;
            }

            // Optimization
            if (state.optimizationEnabled && state.parsingEnabled) {
                const activeServiceType = state.serviceType === "Custom" ? state.customServiceType : state.serviceType;

                if (activeServiceType) {
                    dql += `| filter matchesPhrase(content, "${activeServiceType}") // Optimization: Pre-filter\n`;
                }
                if (state.serviceName) {
                    dql += `| filter matchesPhrase(content, "${state.serviceName}") // Optimization: Pre-filter\n`;
                }
            }

            // Phrases
            state.phrases.forEach(p => {
                if (!p.enabled) return;
                let value = p.value;
                let func = "matchesPhrase";
                if (p.isWildcard) {
                    value = `*${value}*`;
                    func = "matchesValue";
                }
                dql += `| filter ${func}(content, "${value}")\n`;
            });

            dql += `| sort timestamp ${state.sortOrder}\n`;

            // Parsing & Logic
            if (state.parsingEnabled) {
                dql += `| parse content, "json:jcontent"\n`;
                dql += `| parse jcontent[message], "json:jmessage"\n`;

                const enabledFields = state.outputFields.filter(f => f.enabled);
                if (enabledFields.length > 0) {
                    dql += `| fields `;
                    const fieldStrings = enabledFields.map(f => {
                        return f.expression ? `${f.id} = ${f.expression}` : f.id;
                    });
                    dql += fieldStrings.join(',\n         ');
                    dql += '\n';
                }

                const activeServiceType = state.serviceType === "Custom" ? state.customServiceType : state.serviceType;
                if (activeServiceType) {
                    dql += `| filter serviceType == "${activeServiceType}"\n`;
                }
                if (state.serviceName) {
                    dql += `| filter serviceName == "${state.serviceName}"\n`;
                }
                if (state.statusCode) {
                    dql += `| filter statusCode == "${state.statusCode}"\n`;
                }
            }

            dql += `| limit ${state.limit}`;

            // Update Output
            els.outputArea.value = dql;
            updateOutputStats();
        }

        function updateOutputStats() {
            const dql = els.outputArea.value;
            els.lineCount.textContent = `${dql.split('\n').length} lines`;
            els.charCount.textContent = `${dql.length} chars`;
        }

        function renderManualOverrideUI() {
            const toggle = els.manualOverrideToggle;
            const circle = toggle.querySelector('div');
            const indicator = els.manualModeIndicator;
            const container = els.outputContainer;

            if (state.manualOverrideEnabled) {
                toggle.className = 'w-8 h-4 rounded-full p-0.5 cursor-pointer transition-colors bg-amber-500';
                circle.className = 'w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform translate-x-4';
                indicator.classList.remove('hidden');
                els.outputArea.removeAttribute('readonly');
                els.outputArea.classList.add('output-editable');
                els.outputStatus.textContent = 'Manual editing mode - changes will sync to inputs';
            } else {
                toggle.className = 'w-8 h-4 rounded-full p-0.5 cursor-pointer transition-colors bg-slate-600';
                circle.className = 'w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform translate-x-0';
                indicator.classList.add('hidden');
                els.outputArea.setAttribute('readonly', 'true');
                els.outputArea.classList.remove('output-editable');
                els.outputStatus.textContent = 'Auto-generated based on inputs';
            }
            lucide.createIcons();
        }

        // --- DQL Parser (for Manual Override Mode) ---
        function parseDQLToState(dql) {
            // Parse the DQL query and extract values back to state
            const lines = dql.split('\n');

            // Reset some state values before parsing
            state.phrases = [];

            lines.forEach(line => {
                line = line.trim();

                // Parse fetch logs with time
                const fetchMatch = line.match(/^fetch logs(?:, from: (-?\d+h|"[^"]+"))?(?:, to: "([^"]+)")?/);
                if (fetchMatch) {
                    if (fetchMatch[1]) {
                        if (fetchMatch[1].startsWith('-') && fetchMatch[1].endsWith('h')) {
                            state.timeMode = 'relative';
                            state.relativeTime = parseInt(fetchMatch[1].slice(1, -1));
                        } else if (fetchMatch[1].startsWith('"')) {
                            state.timeMode = 'range';
                            state.startTime = fetchMatch[1].slice(1, -1);
                        }
                    } else {
                        state.timeMode = 'none';
                    }
                    if (fetchMatch[2]) {
                        state.endTime = fetchMatch[2];
                    }
                }

                // Parse namespace filter
                const nsMatch = line.match(/filter matchesValue\(k8s\.namespace\.name, "([^"]+)"\)/);
                if (nsMatch) {
                    const ns = nsMatch[1];
                    const predefined = ['api-factory-dev', 'api-factory-sit', 'api-factory-uat'];
                    if (predefined.includes(ns)) {
                        state.namespace = ns;
                        state.customNamespace = '';
                    } else {
                        state.namespace = 'Custom';
                        state.customNamespace = ns;
                    }
                }

                // Parse content path
                const contentMatch = line.match(/filter matchesValue\(content, "([^"]+)"\)$/);
                if (contentMatch && !line.includes('// Optimization')) {
                    // Check if this looks like a content path (contains *)
                    if (contentMatch[1].includes('*') && contentMatch[1].includes('/')) {
                        state.contentPath = contentMatch[1];
                    } else {
                        // It's a phrase filter with wildcard
                        const value = contentMatch[1].replace(/^\*|\*$/g, '');
                        state.phrases.push({
                            id: Date.now() + Math.random(),
                            value: value,
                            enabled: true,
                            isWildcard: true
                        });
                    }
                }

                // Parse phrase filters
                const phraseMatch = line.match(/filter matchesPhrase\(content, "([^"]+)"\)(?!.*Optimization)/);
                if (phraseMatch) {
                    state.phrases.push({
                        id: Date.now() + Math.random(),
                        value: phraseMatch[1],
                        enabled: true,
                        isWildcard: false
                    });
                }

                // Parse sort order
                const sortMatch = line.match(/sort timestamp (asc|desc)/);
                if (sortMatch) {
                    state.sortOrder = sortMatch[1];
                }

                // Parse limit
                const limitMatch = line.match(/limit (\d+)/);
                if (limitMatch) {
                    state.limit = parseInt(limitMatch[1]);
                }

                // Parse service type filter
                const stMatch = line.match(/filter serviceType == "([^"]+)"/);
                if (stMatch) {
                    const st = stMatch[1];
                    const predefined = ['SELF', 'DB', 'DataSource', 'KAFKA-TOPIC-LISTENER', 'PUBSUB-QUEUE-LISTENER', 'RestTemplate', 'RestTemplate-Annotation', 'RestTemplate-Annotation-Proxy'];
                    if (predefined.includes(st)) {
                        state.serviceType = st;
                        state.customServiceType = '';
                    } else {
                        state.serviceType = 'Custom';
                        state.customServiceType = st;
                    }
                }

                // Parse service name filter
                const snMatch = line.match(/filter serviceName == "([^"]+)"/);
                if (snMatch) {
                    state.serviceName = snMatch[1];
                }

                // Parse status code filter
                const scMatch = line.match(/filter statusCode == "([^"]+)"/);
                if (scMatch) {
                    state.statusCode = scMatch[1];
                }

                // Check if parsing is enabled (has json:jcontent)
                if (line.includes('parse content, "json:jcontent"')) {
                    state.parsingEnabled = true;
                }
            });

            // Update all UI elements
            updateUIFromState();
        }

        function updateUIFromState() {
            els.relativeTimeInput.value = state.relativeTime;
            els.startTimeInput.value = state.startTime;
            els.endTimeInput.value = state.endTime;
            els.namespaceSelect.value = state.namespace;
            els.customNamespaceInput.value = state.customNamespace;
            els.contentPathInput.value = state.contentPath;
            els.serviceTypeSelect.value = state.serviceType;
            els.customServiceTypeInput.value = state.customServiceType;
            els.serviceNameInput.value = state.serviceName;
            els.statusCodeInput.value = state.statusCode;
            els.limitInput.value = state.limit;

            renderTimeUI();
            renderNamespaceUI();
            renderServiceUI();
            renderParsingUI();
            renderPhrases();
            renderFields();
            renderSortUI();
        }

        // --- Event Handlers & Helpers ---

        // Global functions for inline HTML events
        window.updatePhrase = (id, field, value) => {
            const idx = state.phrases.findIndex(p => p.id === id);
            if (idx > -1) {
                state.phrases[idx][field] = value;
                // Re-render only if we need to update styling, otherwise just regen DQL
                if (field === 'enabled') {
                    renderPhrases();
                }
                generateDQL();
            }
        };

        window.removePhrase = (id) => {
            state.phrases = state.phrases.filter(p => p.id !== id);
            renderPhrases();
            generateDQL();
        };

        window.toggleField = (id) => {
            const idx = state.outputFields.findIndex(f => f.id === id);
            if (idx > -1) {
                state.outputFields[idx].enabled = !state.outputFields[idx].enabled;
                renderFields();
                generateDQL();
            }
        };

        // DOM Event Listeners
        els.timeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                state.timeMode = btn.dataset.mode;
                renderTimeUI();
                generateDQL();
            });
        });

        els.relativeTimeInput.addEventListener('input', (e) => {
            state.relativeTime = e.target.value;
            generateDQL();
        });

        els.startTimeInput.addEventListener('input', (e) => {
            state.startTime = e.target.value;
            generateDQL();
        });

        els.endTimeInput.addEventListener('input', (e) => {
            state.endTime = e.target.value;
            generateDQL();
        });

        els.namespaceSelect.addEventListener('change', (e) => {
            state.namespace = e.target.value;
            renderNamespaceUI();
            generateDQL();
        });

        els.customNamespaceInput.addEventListener('input', (e) => {
            state.customNamespace = e.target.value;
            generateDQL();
        });

        els.contentPathInput.addEventListener('input', (e) => {
            state.contentPath = e.target.value;
            generateDQL();
        });

        els.addPhraseBtn.addEventListener('click', () => {
            state.phrases.push({ id: Date.now(), value: "", enabled: true, isWildcard: true });
            renderPhrases();
            generateDQL();
        });

        els.parsingToggle.addEventListener('click', () => {
            state.parsingEnabled = !state.parsingEnabled;
            renderParsingUI();
            generateDQL();
        });

        els.optToggle.addEventListener('click', () => {
            state.optimizationEnabled = !state.optimizationEnabled;
            renderParsingUI(); // Updates UI
            generateDQL();
        });

        els.serviceTypeSelect.addEventListener('change', (e) => {
            state.serviceType = e.target.value;
            renderServiceUI();
            generateDQL();
        });

        els.customServiceTypeInput.addEventListener('input', (e) => {
            state.customServiceType = e.target.value;
            generateDQL();
        });

        els.serviceNameInput.addEventListener('input', (e) => {
            state.serviceName = e.target.value;
            generateDQL();
        });

        els.statusCodeInput.addEventListener('input', (e) => {
            state.statusCode = e.target.value;
            generateDQL();
        });

        els.sortDescBtn.addEventListener('click', () => {
            state.sortOrder = 'desc';
            renderSortUI();
            generateDQL();
        });

        els.sortAscBtn.addEventListener('click', () => {
            state.sortOrder = 'asc';
            renderSortUI();
            generateDQL();
        });

        els.limitInput.addEventListener('input', (e) => {
            state.limit = e.target.value;
            generateDQL();
        });

        els.copyBtn.addEventListener('click', () => {
            els.outputArea.select();
            document.execCommand('copy');

            // Save to history
            // We save a deep copy of state to ensure history is immutable
            const stateCopy = JSON.parse(JSON.stringify(state));
            HistoryManager.addToHistory('dql-builder', stateCopy);

            // Visual feedback
            const originalText = els.copyBtnText.textContent;
            const icon = els.copyBtn.querySelector('i');
            els.copyBtnText.textContent = "Copied!";
            els.copyBtn.classList.replace('bg-slate-700', 'bg-green-600');

            setTimeout(() => {
                els.copyBtnText.textContent = originalText;
                els.copyBtn.classList.replace('bg-green-600', 'bg-slate-700');
            }, 2000);
        });

        // --- NEW FEATURE EVENT LISTENERS ---

        // Presets Dropdown
        els.presetBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            els.presetMenu.classList.toggle('show');
        });

        document.addEventListener('click', () => {
            els.presetMenu.classList.remove('show');
        });

        // Preset Items
        const presets = {
            'error-logs': {
                statusCode: '500',
                serviceType: 'SELF',
                phrases: [{ id: Date.now(), value: 'error', enabled: true, isWildcard: true }]
            },
            'performance': {
                parsingEnabled: true,
                outputFields: state.outputFields.map(f => ({
                    ...f,
                    enabled: ['timestamp', 'serviceName', 'statusCode', 'message'].includes(f.id)
                }))
            },
            'api-trace': {
                parsingEnabled: true,
                optimizationEnabled: true,
                serviceType: 'SELF',
                outputFields: state.outputFields.map(f => ({ ...f, enabled: true }))
            },
            'kafka': {
                serviceType: 'KAFKA-TOPIC-LISTENER',
                parsingEnabled: true
            },
            'db': {
                serviceType: 'DB',
                parsingEnabled: true,
                outputFields: state.outputFields.map(f => ({
                    ...f,
                    enabled: ['timestamp', 'serviceName', 'statusCode', 'requestData', 'responseData'].includes(f.id)
                }))
            }
        };

        document.querySelectorAll('.preset-item').forEach(item => {
            item.addEventListener('click', () => {
                const presetName = item.dataset.preset;
                const preset = presets[presetName];
                if (preset) {
                    Object.assign(state, preset);
                    updateUIFromState();
                    generateDQL();
                    els.presetMenu.classList.remove('show');
                }
            });
        });

        // Reset Button
        els.resetBtn.addEventListener('click', () => {
            Object.assign(state, JSON.parse(JSON.stringify(defaultState)));
            state.manualOverrideEnabled = false;
            updateUIFromState();
            renderManualOverrideUI();
            generateDQL();
        });

        // Export Button
        els.exportBtn.addEventListener('click', () => {
            const exportData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                state: state,
                query: els.outputArea.value
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dql-config-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // Import Button
        els.importBtn.addEventListener('click', () => {
            els.importFileInput.click();
        });

        els.importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (data.state) {
                        Object.assign(state, data.state);
                        updateUIFromState();
                        generateDQL();
                    }
                } catch (err) {
                    console.error('Failed to import config:', err);
                    alert('Failed to import configuration. Invalid file format.');
                }
            };
            reader.readAsText(file);
            e.target.value = ''; // Reset file input
        });

        // Keyboard Shortcuts Help
        els.shortcutsHelpBtn.addEventListener('click', () => {
            alert(
                'Keyboard Shortcuts:\n\n' +
                'Ctrl+C ‚Äî Copy query to clipboard\n' +
                'Ctrl+Shift+R ‚Äî Reset to defaults\n' +
                'Ctrl+S ‚Äî Download query as file\n' +
                'Ctrl+E ‚Äî Export configuration\n' +
                'Ctrl+M ‚Äî Toggle manual edit mode'
            );
        });

        // Manual Override Toggle
        els.manualOverrideToggle.addEventListener('click', () => {
            state.manualOverrideEnabled = !state.manualOverrideEnabled;
            renderManualOverrideUI();
            if (!state.manualOverrideEnabled) {
                // When turning off manual mode, regenerate from state
                generateDQL();
            }
        });

        // Manual Override: Parse on blur when editing
        let parseTimeout;
        els.outputArea.addEventListener('input', () => {
            if (state.manualOverrideEnabled) {
                updateOutputStats();
                clearTimeout(parseTimeout);
                parseTimeout = setTimeout(() => {
                    parseDQLToState(els.outputArea.value);
                }, 1000); // Debounce parsing
            }
        });

        // Download Button
        els.downloadBtn.addEventListener('click', () => {
            const blob = new Blob([els.outputArea.value], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `query-${new Date().toISOString().split('T')[0]}.dql`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // Field Presets
        els.selectAllFieldsBtn.addEventListener('click', () => {
            state.outputFields.forEach(f => f.enabled = true);
            renderFields();
            generateDQL();
        });

        els.deselectAllFieldsBtn.addEventListener('click', () => {
            state.outputFields.forEach(f => f.enabled = false);
            renderFields();
            generateDQL();
        });

        // Global Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl+Shift+R - Reset
            if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                e.preventDefault();
                els.resetBtn.click();
            }
            // Ctrl+S - Download
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                els.downloadBtn.click();
            }
            // Ctrl+E - Export
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                els.exportBtn.click();
            }
            // Ctrl+M - Toggle Manual Mode
            if (e.ctrlKey && e.key === 'm') {
                e.preventDefault();
                els.manualOverrideToggle.click();
            }
        });

        // Initialize
        renderTimeUI();
        renderNamespaceUI();
        renderServiceUI();
        renderParsingUI();
        renderPhrases();
        renderFields();
        renderSortUI();
        renderManualOverrideUI();
        generateDQL();
        lucide.createIcons();

        // --- Shared Utils Integration ---

        function restoreState(savedState) {
            // Update state object
            if (typeof savedState === 'string') {
                try {
                    savedState = JSON.parse(savedState);
                } catch (e) {
                    // Fallback if string is just DQL query or invalid
                    console.error("Invalid state format");
                    return;
                }
            }

            Object.assign(state, savedState);

            // Update UI inputs to match state
            els.relativeTimeInput.value = state.relativeTime;
            els.startTimeInput.value = state.startTime;
            els.endTimeInput.value = state.endTime;

            els.namespaceSelect.value = state.namespace;
            els.customNamespaceInput.value = state.customNamespace;

            els.contentPathInput.value = state.contentPath;

            els.serviceTypeSelect.value = state.serviceType;
            els.customServiceTypeInput.value = state.customServiceType;
            els.serviceNameInput.value = state.serviceName;
            els.statusCodeInput.value = state.statusCode;

            els.limitInput.value = state.limit;

            // Re-render all UI
            renderTimeUI();
            renderNamespaceUI();
            renderServiceUI();
            renderParsingUI();
            renderPhrases();
            renderFields();
            renderSortUI();

            // Regenerate Output
            generateDQL();
        }

        // Initialize Shared Tools (History, Share, Theme)
        // Must wait for shared-utils.js to be loaded, but it is synchronous at bottom of body
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof initTool === 'function') {
                const sharedData = initTool({
                    toolName: 'dql-builder',
                    onExecute: generateDQL,
                    onHistorySelect: restoreState,
                    getShareData: () => state
                });

                if (sharedData) {
                    restoreState(sharedData);
                }

                // Sync data-theme to Tailwind class
                const syncTheme = () => {
                    const theme = document.documentElement.getAttribute('data-theme');
                    if (theme === 'dark') {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                };

                // Initial sync
                syncTheme();

                // Observe changes
                const observer = new MutationObserver(syncTheme);
                observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
            }
        });

    </script>
    <script src="../../assets/js/shared-utils.js"></script>
</body>

</html>